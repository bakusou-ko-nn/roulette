<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹å‘½ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒ»ã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ãƒƒãƒˆãƒ»ã‚¯ã‚½ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</title>
    <style>
        :root {
            --p-red: #ffb3ba; --p-yellow: #ffffba; --p-orange: #ffdfba;
            --p-blue: #bae1ff; --p-purple: #e2baff; --p-green: #baffc9; --p-gray: #e0e0e0;
            --mint: #f5fff5; --mint-active: #b2ffb2;
            --border-green: #2e7d32;
        }

        body {
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            font-family: "Helvetica Neue", "Arial", "Hiragino Sans", sans-serif;
            background: white; overflow: hidden;
            transition: background 1s ease, filter 0.3s;
        }

        /* èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        #bgCanvas, #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; pointer-events: none; }
        #confettiCanvas { z-index: 5; }

        /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .main-container {
            display: grid; grid-template-columns: 260px 1fr 260px;
            gap: 50px; width: 95%; max-width: 1400px; height: 90vh;
            align-items: center; z-index: 10;
        }

        /* å·¦ãƒ‘ãƒãƒ«ï¼šã‚¿ãƒ–ã¨éŸ³é‡ */
        .left-panel { display: flex; flex-direction: column; gap: 30px; height: 100%; justify-content: center; }
        .vol-section {
            background: #fff; padding: 20px; border-radius: 15px; border: 1px solid #ddd; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .vol-bar { width: 100%; height: 20px; background: #eee; position: relative; margin: 15px 0; border-radius: 10px; overflow: hidden; }
        #volIndicator { position: absolute; top:0; left: 50%; width: 4px; height: 100%; background: #4a90e2; }
        #volBall { width: 20px; height: 20px; background: #ff4444; border-radius: 50%; position: absolute; top: -50px; display: none; }
        
        .tabs { display: flex; flex-direction: column; gap: 10px; }
        .tab-btn {
            padding: 15px; border: 1px solid var(--border-green); background: white;
            cursor: pointer; border-radius: 8px; text-align: left; transition: 0.3s;
            display: flex; justify-content: space-between;
        }
        .tab-btn.active { background: var(--mint-active); border-radius: 20px; font-weight: bold; }
        
        .sys-btns { display: flex; flex-direction: column; gap: 10px; }
        .btn-base { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-url { background: var(--p-blue); }
        .btn-reset { background: var(--p-red); }
        .btn-undo { background: var(--p-yellow); font-size: 12px; }

        /* ä¸­å¤®ãƒ‘ãƒãƒ«ï¼šãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ */
        .center-panel { display: flex; flex-direction: column; align-items: center; position: relative; }
        #resText { font-size: 48px; font-weight: bold; margin-bottom: 20px; height: 60px; color: #333; text-align: center; }
        .r-wrap { position: relative; transition: all 0.5s; }
        #needle { font-size: 60px; color: #ff4444; position: absolute; top: -40px; left: 50%; transform: translateX(-50%); z-index: 20; }
        canvas#rCvs { border-radius: 50%; background: white; box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 8px solid #ddd; }
        
        #spinBtn {
            width: 260px; height: 70px; font-size: 28px; background: #66cc66; color: white;
            border: none; border-bottom: 6px solid #44aa44; border-radius: 15px;
            margin: 30px 0; cursor: pointer; font-weight: bold;
        }
        #spinBtn:active { transform: translateY(3px); border-bottom-width: 2px; }
        #itemsArea { width: 100%; max-width: 500px; height: 150px; padding: 15px; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; line-height: 1.5; }

        /* å³ãƒ‘ãƒãƒ«ï¼šå±¥æ­´ */
        .right-panel { height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .hist-box {
            border: 2px solid #ffb3ba; border-radius: 15px; background: white;
            height: 500px; display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .hist-title { background: #fff0f0; padding: 10px; text-align: center; font-weight: bold; color: #ff6b6b; border-bottom: 1px solid #ffb3ba; }
        #histUl { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        #histUl li { padding: 12px; border-bottom: 1px dotted #ffb3ba; text-align: center; font-size: 14px; color: #555; }

        /* ã‚¯ã‚½ã‚¤ãƒ™ãƒ³ãƒˆç”¨ç‰¹æ®Šã‚¹ã‚¿ã‚¤ãƒ« */
        .c-invert { filter: invert(1); }
        .c-mosaic { filter: blur(10px) contrast(200%); }
        .c-darkmode { background: #111 !important; }
        .c-darkmode #resText { color: white; }
        .c-darkmode .r-wrap { opacity: 0.1; }
        .c-fall { transform: translateY(1000px) rotate(45deg) !important; }
        .c-ghost { opacity: 0 !important; }
        .c-mini { transform: scale(0.3) translate(300px, 300px); }
        
        #fakeBanner {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 500px; padding: 40px; background: #fff000; border: 10px solid red;
            z-index: 1000; display: none; text-align: center; font-weight: bold;
        }
        #closeX { font-size: 120px; color: red; cursor: pointer; display: block; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<canvas id="confettiCanvas"></canvas>

<div id="fakeBanner">
    å½“é¸ç¢ºç‡10000%UPä¸­ï¼ï¼<br>ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼
    <span id="closeX" onclick="this.parentElement.style.display='none'">Ã—</span>
    <p>ï¼ˆâ†‘ é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãŒãƒ‡ã‚«ã„ã ã‘ï¼‰</p>
</div>

<div class="main-container">
    <div class="left-panel">
        <div class="vol-section">
            <div style="font-size: 12px; color: #888;">VOLUME: <span id="volVal">50</span>%</div>
            <div class="vol-bar" id="volBar">
                <div id="volIndicator"></div>
                <div id="volBall"></div>
            </div>
            <button class="btn-base" style="width: 100%; margin-bottom: 5px;" onclick="dropVolBall()">ğŸ”Š éŸ³é‡æŠ½é¸</button>
            <button class="btn-base" style="width: 100%; background: #eee;" onclick="toggleMute()" id="muteBtn">ğŸ”‡ MUTE: OFF</button>
        </div>

        <div class="tabs" id="tabsArea"></div>

        <div class="sys-btns">
            <button class="btn-base btn-url" onclick="issueUrl()">ğŸ”— ä¿å­˜ãƒ»URLç™ºè¡Œ</button>
            <button class="btn-base btn-reset" onclick="resetRoulette()">âš ï¸ ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="btn-base btn-undo" onclick="undoReset()">â†©ï¸ æ¶ˆã™å‰ã‚’å¾©æ´»</button>
        </div>
    </div>

    <div class="center-panel">
        <div id="resText">READY</div>
        <div class="r-wrap" id="rWrap">
            <div id="needle">â–¼</div>
            <canvas id="rCvs" width="500" height="500"></canvas>
        </div>
        <button id="spinBtn" onclick="handleSpin()">SPIN!</button>
        <textarea id="itemsArea" placeholder="ã“ã“ã«å˜èªã‚’æ”¹è¡Œã§å…¥åŠ›ï¼ˆæœ€å¤§500ä»¶ï¼‰"></textarea>
    </div>

    <div class="right-panel">
        <div class="hist-box">
            <div class="hist-title">HISTORY (LAST 10)</div>
            <ul id="histUl"></ul>
        </div>
    </div>
</div>

<script>
// --- åŸºæœ¬è¨­å®š ---
const COLORS = ['#ffb3ba', '#ffffba', '#ffdfba', '#bae1ff', '#e2baff', '#baffc9', '#e0e0e0'];
let items = [], hist = [], spinning = false, globalVol = 0.5, isMuted = false;
let tabs = [
    { name: "ãƒªã‚¹ãƒˆ 1", content: "å¤§å‰\nä¸­å‰\nå°å‰\nå‰\næœ«å‰\nå‡¶" },
    { name: "ãƒªã‚¹ãƒˆ 2", content: "" },
    { name: "ãƒªã‚¹ãƒˆ 3", content: "" },
    { name: "ãƒªã‚¹ãƒˆ 4", content: "" },
    { name: "ãƒªã‚¹ãƒˆ 5", content: "" }
];
let curTabIdx = 0;
let lastContent = "";
let clickCount = 0;

// --- åˆæœŸåŒ– ---
window.onload = () => {
    initBg();
    renderTabs();
    syncTab();
    loop();
};

function syncTab() {
    document.getElementById('itemsArea').value = tabs[curTabIdx].content;
    updateItems();
}

function updateItems() {
    items = document.getElementById('itemsArea').value.split('\n').filter(t => t.trim() !== "").slice(0, 500);
    tabs[curTabIdx].content = document.getElementById('itemsArea').value;
    drawRoulette();
}
document.getElementById('itemsArea').addEventListener('input', updateItems);

// --- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæç”» ---
function drawRoulette(offset = 0) {
    const cvs = document.getElementById('rCvs'), ctx = cvs.getContext('2d'), r = cvs.width / 2;
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    if (items.length === 0) return;

    const arc = (Math.PI * 2) / items.length;
    items.forEach((txt, i) => {
        const ang = offset + (i * arc);
        ctx.beginPath();
        ctx.moveTo(r, r);
        ctx.arc(r, r, r - 10, ang, ang + arc);
        ctx.fillStyle = COLORS[i % COLORS.length];
        ctx.fill();
        ctx.strokeStyle = "white";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.save();
        ctx.translate(r, r);
        ctx.rotate(ang + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#333";
        ctx.font = "bold 20px sans-serif";
        ctx.fillText(txt.slice(0, 10), r - 40, 10);
        ctx.restore();
    });
}

// --- éŸ³é‡ãƒ»UIæ©Ÿèƒ½ ---
function dropVolBall() {
    const b = document.getElementById('volBall'), bar = document.getElementById('volBar');
    b.style.display = "block";
    let y = -50, speed = 2, x = Math.random() * (bar.offsetWidth - 20);
    b.style.left = x + "px";
    const itv = setInterval(() => {
        y += speed; speed += 0.5; b.style.top = y + "px";
        if (y >= 0) {
            clearInterval(itv);
            globalVol = x / bar.offsetWidth;
            document.getElementById('volIndicator').style.left = x + "px";
            document.getElementById('volVal').innerText = Math.round(globalVol * 100);
            b.style.display = "none";
        }
    }, 20);
}

function toggleMute() {
    isMuted = !isMuted;
    document.getElementById('muteBtn').innerText = isMuted ? "ğŸ”Š MUTE: ON" : "ğŸ”‡ MUTE: OFF";
}

function playSnd(url, forceVol = null) {
    if (isMuted) return null;
    const a = new Audio(url);
    a.volume = forceVol !== null ? forceVol : globalVol;
    a.play().catch(() => {});
    return a;
}

// --- ã‚¹ãƒ”ãƒ³å‡¦ç† ---
async function handleSpin() {
    if (spinning || items.length === 0) return;

    // 20%ã§ã‚¯ã‚½ã‚¤ãƒ™ãƒ³ãƒˆæŠ½é¸
    const isEvent = Math.random() < 0.2;
    const eventType = isEvent ? Math.floor(Math.random() * 25) : -1;

    // --- äº‹å‰å«ŒãŒã‚‰ã›ã‚¤ãƒ™ãƒ³ãƒˆ ---
    if (eventType === 20) { // é€£æ‰“è¦æ±‚
        if (clickCount < 100) {
            clickCount++;
            document.getElementById('resText').innerText = `ã‚ã¨${100 - clickCount}å›é€£æ‰“ã—ã‚`;
            return;
        }
        clickCount = 0;
    }
    if (eventType === 21) { // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåœ°ç„
        for(let i=0; i<10; i++) { if(!confirm(`æœ¬å½“ã«å›ã™ã®ï¼Ÿ (${i+1}/10)`)) return; }
    }
    if (eventType === 22) { // åºƒå‘ŠãƒãƒŠãƒ¼
        document.getElementById('fakeBanner').style.display = 'block';
    }

    spinning = true;
    resetVisuals();

    const rollSnd = playSnd("https://soundeffect-lab.info/sound/anime/mp3/tympani-roll1.mp3");
    if (rollSnd) rollSnd.loop = true;

    const winIdx = Math.floor(Math.random() * items.length);
    let rotations = 10 + Math.random() * 5;
    const arc = (Math.PI * 2) / items.length;
    
    // ã‚¤ãƒ™ãƒ³ãƒˆï¼šé€†å™´å°„
    const isReverse = eventType === 3;
    const direction = isReverse ? -1 : 1;

    // ã‚¤ãƒ™ãƒ³ãƒˆï¼šé€æ˜åŒ–
    if (eventType === 23) document.getElementById('rCvs').classList.add('c-ghost');

    let start = performance.now();
    const duration = 5000;

    function animate(now) {
        let progress = Math.min((now - start) / duration, 1);
        
        // ã‚¤ãƒ™ãƒ³ãƒˆï¼šä½è§£åƒåº¦ï¼ˆå›ã‚‹ã»ã©ãƒ¢ã‚¶ã‚¤ã‚¯ï¼‰
        if (eventType === 17) document.body.style.filter = `blur(${progress * 10}px)`;

        let ease = 1 - Math.pow(1 - progress, 4);
        let currentAng = (rotations * Math.PI * 2 * ease) * direction;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆï¼šãƒ¯ãƒ¼ãƒ—ï¼ˆé‡ãŒã™ã‚ŠæŠœã‘ã‚‹æ¼”å‡ºã¯æç”»ã‚ªãƒ•ã‚»ãƒƒãƒˆã§å†ç¾ï¼‰
        if (eventType === 8 && progress > 0.8) currentAng += Math.PI;

        drawRoulette(currentAng);

        if (progress < 1) {
            requestAnimationFrame(animate);
        } else {
            if (rollSnd) rollSnd.pause();
            finalize(winIdx, eventType);
        }
    }
    requestAnimationFrame(animate);
}

function finalize(winIdx, eventType) {
    spinning = false;
    let winItem = items[winIdx];
    const winColor = COLORS[winIdx % COLORS.length];

    // ã‚¤ãƒ™ãƒ³ãƒˆï¼šå¼·åˆ¶ã‚„ã‚Šç›´ã—
    if (eventType === 24) {
        alert("ã‚¨ãƒ©ãƒ¼ï¼šã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„");
        resetVisuals();
        return;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆï¼šéŸ³é‡é€†è»¢ (çˆ†éŸ³)
    const finalVol = eventType === 22 ? 0.7 : globalVol;
    playSnd("https://soundeffect-lab.info/sound/anime/mp3/trumpet-majime1.mp3", finalVol);

    // èƒŒæ™¯è‰²å¤‰æ›´
    document.body.style.background = `linear-gradient(to bottom, ${winColor}, white)`;

    // ã‚¤ãƒ™ãƒ³ãƒˆï¼šæ–‡å­—åŒ–ã‘
    let displayText = winItem;
    if (eventType === 11) displayText = "â–¯â–¯â–¯â–¯â–¯â–¯";
    if (eventType === 16) { // ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š
        items = items.map(() => winItem);
        drawRoulette();
    }

    document.getElementById('resText').innerText = displayText;

    // è¦–è¦šçš„ã‚¤ãƒ™ãƒ³ãƒˆé©ç”¨
    if (eventType === 1) document.getElementById('rWrap').style.transition = "none"; // æ€¥åœæ­¢ç”¨
    if (eventType === 5) document.getElementById('rWrap').classList.add('c-fall'); // é‡åŠ›
    if (eventType === 18) document.body.classList.add('c-invert'); // åè»¢
    if (eventType === 22) document.body.classList.add('c-darkmode'); // æš—é—‡
    if (eventType === 14) { // çˆ†ç™º
        document.getElementById('resText').innerText = "ãƒ‰ã‚«ãƒ¼ãƒ³ï¼";
        document.getElementById('rWrap').classList.add('c-ghost');
    }

    // å±¥æ­´æ›´æ–°
    hist.unshift(winItem);
    if (hist.length > 10) hist.pop();
    renderHist();
}

function resetVisuals() {
    document.body.className = "";
    document.body.style.filter = "";
    document.getElementById('rWrap').className = "r-wrap";
    document.getElementById('rCvs').className = "";
    document.getElementById('fakeBanner').style.display = "none";
}

// --- ãã®ä»–UI ---
function renderTabs() {
    const area = document.getElementById('tabsArea');
    area.innerHTML = "";
    tabs.forEach((t, i) => {
        const b = document.createElement('div');
        b.className = `tab-btn ${i === curTabIdx ? 'active' : ''}`;
        b.innerHTML = `<span onclick="selectTab(${i})">${t.name}</span><span style="font-size:10px; opacity:0.5;" onclick="renameTab(${i})">ç·¨é›†</span>`;
        area.appendChild(b);
    });
}
function selectTab(i) { curTabIdx = i; renderTabs(); syncTab(); }
function renameTab(i) { const n = prompt("åå‰å¤‰æ›´:", tabs[i].name); if(n) { tabs[i].name = n; renderTabs(); } }

function renderHist() {
    const ul = document.getElementById('histUl');
    ul.innerHTML = hist.map(h => `<li>${h}</li>`).join('');
}

function resetRoulette() {
    if (confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
        lastContent = document.getElementById('itemsArea').value;
        document.getElementById('itemsArea').value = "";
        updateItems();
        resetVisuals();
    }
}
function undoReset() {
    if (lastContent) {
        document.getElementById('itemsArea').value = lastContent;
        updateItems();
    }
}

function issueUrl() {
    const data = btoa(encodeURIComponent(JSON.stringify(tabs)));
    const url = location.origin + location.pathname + "#" + data;
    navigator.clipboard.writeText(url);
    alert("ğŸ”— ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ã“ã®URLã‹ã‚‰ã„ã¤ã§ã‚‚å¾©å…ƒã§ãã¾ã™ã€‚");
}

// --- èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ---
let shapes = [];
function initBg() {
    const c = document.getElementById('bgCanvas');
    c.width = window.innerWidth; c.height = window.innerHeight;
    for(let i=0; i<30; i++) {
        shapes.push({
            x: Math.random() * c.width, y: Math.random() * c.height,
            size: Math.random() * 30 + 10,
            type: Math.floor(Math.random() * 3),
            speed: Math.random() * 2 + 1,
            color: COLORS[Math.floor(Math.random() * COLORS.length)]
        });
    }
}

function loop() {
    const c = document.getElementById('bgCanvas'), ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    shapes.forEach(s => {
        s.y += s.speed;
        if (s.y > c.height) s.y = -50;
        ctx.fillStyle = s.color;
        ctx.globalAlpha = 0.4;
        ctx.beginPath();
        if(s.type === 0) ctx.arc(s.x, s.y, s.size/2, 0, Math.PI*2);
        else if(s.type === 1) ctx.fillRect(s.x, s.y, s.size, s.size);
        else { ctx.moveTo(s.x, s.y); ctx.lineTo(s.x+s.size, s.y+s.size); ctx.lineTo(s.x-s.size, s.y+s.size); ctx.closePath(); }
        ctx.fill();
    });
    requestAnimationFrame(loop);
}
</script>
</body>
</html>
