<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹å‘½ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒ»ã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ãƒƒãƒˆ EXï¼ˆåœ§ç¸®ç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        :root {
            --bg-grad: linear-gradient(to bottom, #ffffff 0%, #f0f2f5 100%);
            --text-color: #333;
            --p-red: #ffb3ba; --p-yellow: #ffffba; --p-orange: #ffdfba;
            --p-blue: #bae1ff; --p-purple: #e2baff; --p-green: #baffc9;
            --p-gray: #e0e0e0; --mint-active: #b2ffb2; --border-deep: #4a90e2;
        }
        * { box-sizing: border-box; }
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            margin: 0; padding: 0; background: var(--bg-grad); color: var(--text-color);
            overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center;
            transition: background 1.2s ease;
        }
        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .container { display: grid; grid-template-columns: 240px 1fr 240px; gap: 40px; width: 95%; max-width: 1300px; height: 85vh; position: relative; z-index: 1; }
        
        .left-panel { display: flex; flex-direction: column; gap: 20px; justify-content: center; }
        .audio-box { border: 1px solid #ddd; padding: 15px; border-radius: 15px; background: rgba(255, 255, 255, 0.9); text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .vol-game { position: relative; height: 70px; border-bottom: 3px solid #ccc; margin-bottom: 10px; background: #fff; overflow: hidden; border-radius: 5px; }
        #volBall { width: 18px; height: 18px; background: #ff6b6b; border-radius: 50%; position: absolute; top: 0; left: 50%; display: none; }
        .vol-info { font-size: 11px; color: #888; margin-bottom: 5px; }
        #volText { font-weight: bold; color: #4a90e2; font-size: 16px; }

        .tabs { display: flex; flex-direction: column; gap: 8px; }
        .tab-item { padding: 12px; border: 1px solid #eee; background: white; cursor: pointer; border-radius: 10px; transition: 0.3s; display: flex; justify-content: space-between; font-size: 13px; }
        .tab-item.active { background-color: var(--mint-active); border-color: transparent; font-weight: bold; transform: scale(1.05); }
        .sys-btns { display: flex; flex-direction: column; gap: 8px; }
        button { padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.95); }

        .center-panel { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .res-display { font-size: 32px; font-weight: bold; margin-bottom: 15px; height: 45px; text-align: center; color: #333; text-shadow: 0 0 10px rgba(255,255,255,0.8); }
        .r-wrap { position: relative; margin-bottom: 20px; }
        .needle { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 40px; z-index: 10; text-shadow: 0 2px 5px rgba(0,0,0,0.2); color: #ff4444; }
        canvas#rCvs { border-radius: 50%; box-shadow: 0 10px 40px rgba(0,0,0,0.15); background: white; }
        #spinBtn { width: 220px; height: 60px; font-size: 24px; background: #66cc66; color: white; border-bottom: 5px solid #44aa44; margin-bottom: 15px; }
        textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; background: rgba(255,255,255,0.85); resize: none; }

        .right-panel { display: flex; flex-direction: column; justify-content: center; }
        .hist-card { border: 1px solid #eee; border-radius: 20px; padding: 15px; height: 70%; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .hist-title { text-align: center; color: #888; font-size: 12px; margin-bottom: 10px; border-bottom: 1px solid #eee; }
        .hist-list { list-style: none; padding: 0; overflow-y: auto; flex: 1; margin: 0; }
        .hist-list li { padding: 8px; border-bottom: 1px solid #f9f9f9; font-size: 14px; text-align: center; animation: fadeIn 0.5s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }

        /* ç‰¹æ®Šæ¼”å‡ºç”¨ */
        .c-dark { filter: invert(1) hue-rotate(180deg); background: #000 !important; }
        .c-pixel { image-rendering: pixelated; transform: scale(0.1) rotate(720deg); transition: 5s; }
        .c-fall { transform: translateY(150vh) rotate(45deg); transition: 1.5s ease-in; }
        .c-ghost { opacity: 0.1; }
        #fakeAd { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; padding: 20px; background: #fff000; border: 5px solid red; z-index: 999; display: none; text-align: center; box-shadow: 10px 10px 0 black; }
        #modalHell { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div class="container">
    <div class="left-panel">
        <div class="audio-box">
            <div class="vol-info">VOL: <span id="volText">50%</span></div>
            <div class="vol-game" id="volGame"><div id="volBall"></div></div>
            <button onclick="dropBall()" style="background:#f0f0f0; width:100%;">ğŸ”Š éŸ³é‡æŠ½é¸</button>
            <button onclick="toggleMute()" id="muteBtn" style="background:#f0f0f0; width:100%; margin-top:5px;">ğŸ”‡ Mute: OFF</button>
        </div>
        <div class="tabs" id="tabs"></div>
        <div class="sys-btns">
            <button onclick="copyUrl()" style="background:var(--p-blue)">ğŸ”— ä¿å­˜ãƒ»URLã‚³ãƒ”ãƒ¼</button>
            <button onclick="hardReset()" style="background:var(--p-red)">âš ï¸ ãƒªã‚»ãƒƒãƒˆ</button>
            <button onclick="undo()" style="background:var(--p-yellow); font-size:11px;">â†©ï¸ æˆ»ã™(Undo)</button>
        </div>
    </div>

    <div class="center-panel">
        <div class="res-display" id="resText">READY</div>
        <div class="r-wrap" id="rWrap">
            <div class="needle">â–¼</div>
            <canvas id="rCvs" width="380" height="380"></canvas>
        </div>
        <button id="spinBtn" onclick="spin()">START</button>
        <textarea id="itemsArea" placeholder="é …ç›®ã‚’æ”¹è¡Œã§å…¥åŠ›..."></textarea>
    </div>

    <div class="right-panel">
        <div class="hist-card">
            <div class="hist-title">HISTORY</div>
            <ul class="hist-list" id="histUl"></ul>
        </div>
    </div>
</div>

<div id="fakeAd"><b>âš ï¸é‡è¦ãªãŠçŸ¥ã‚‰ã›âš ï¸</b><p>ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼<br>ã‚ãªãŸã¯100ä¸‡äººç›®ã®è¨ªå•è€…ã§ã™</p><button onclick="this.parentElement.style.display='none'">å—ã‘å–ã‚‹</button></div>
<div id="modalHell"><div style="background:white; padding:40px; border-radius:20px; text-align:center;"><p id="mMsg" style="font-size:20px; font-weight:bold;">æº–å‚™ã¯ã„ã„ã§ã™ã‹ï¼Ÿ</p><button onclick="nextM()" style="font-size:18px; padding:10px 30px; background:red; color:white;">ã¯ã„</button></div></div>

<script>
const COLORS = ['#ffb3ba', '#ffffba', '#ffdfba', '#bae1ff', '#e2baff', '#baffc9', '#ffccf9'];
let items = [], hist = [], prevStr = "", spinning = false, currentCType = null, bgm = null;
let tabs = [ { name: "ã‚¿ãƒ– 1", content: "ç„¼è‚‰\nå¯¿å¸\nã†ã©ã‚“\nã‚«ãƒ¬ãƒ¼\nãƒãƒ³ãƒãƒ¼ã‚°\nãƒ”ã‚¶" }, { name: "ã‚¿ãƒ– 2", content: "" }, { name: "ã‚¿ãƒ– 3", content: "" }, { name: "ã‚¿ãƒ– 4", content: "" }, { name: "ã‚¿ãƒ– 5", content: "" } ];
let curTabIdx = 0;
let globalVol = 0.5;
let isMuted = false;

window.onload = () => { loadHash(); renderTabs(); syncTab(); initBg(); updateVolDisp(); };

function syncTab() { document.getElementById('itemsArea').value = tabs[curTabIdx].content; updateItems(); }
function updateItems() {
    items = document.getElementById('itemsArea').value.split('\n').filter(t => t.trim() !== "").slice(0, 500);
    tabs[curTabIdx].content = document.getElementById('itemsArea').value;
    drawRoulette();
}
document.getElementById('itemsArea').addEventListener('input', updateItems);

function drawRoulette(offset = 0) {
    const cvs = document.getElementById('rCvs'), ctx = cvs.getContext('2d'), r = cvs.width / 2;
    ctx.clearRect(0,0,cvs.width,cvs.height);
    ctx.beginPath(); ctx.arc(r,r,r-5,0,Math.PI*2); ctx.fillStyle="#fff"; ctx.fill();
    ctx.lineWidth=4; ctx.strokeStyle="#ddd"; ctx.stroke();
    if(items.length === 0) return;
    const arc = (Math.PI*2) / items.length;
    items.forEach((txt, i) => {
        const ang = offset + (i * arc);
        ctx.beginPath(); ctx.moveTo(r,r); ctx.arc(r,r,r-8,ang,ang+arc);
        ctx.fillStyle = COLORS[i % COLORS.length]; ctx.fill();
        ctx.save(); ctx.translate(r,r); ctx.rotate(ang + arc/2); ctx.textAlign="right"; ctx.fillStyle="#333";
        ctx.font="bold 15px sans-serif"; ctx.fillText(txt.length > 9 ? txt.slice(0,8)+'..' : txt, r-25, 5); ctx.restore();
    });
}

function dropBall() {
    const b = document.getElementById('volBall'); b.style.display="block"; b.style.top="0";
    b.style.left = Math.random() * 80 + 10 + "%";
    let y=0, speed=1;
    const itv = setInterval(()=>{
        y+=speed; speed+=0.8; b.style.top=y+'px';
        if(y>60) { clearInterval(itv); globalVol = Math.random(); updateVolDisp(); playS('win'); }
    },20);
}
function updateVolDisp() { document.getElementById('volText').innerText = Math.round(globalVol * 100) + "%"; }
function toggleMute() { isMuted = !isMuted; document.getElementById('muteBtn').innerText = isMuted ? "ğŸ”‡ Mute: ON" : "ğŸ”‡ Mute: OFF"; }

function playS(type) {
    if(isMuted) return;
    if(type === 'roll') {
        if(bgm) bgm.pause();
        bgm = new Audio("https://soundeffect-lab.info/sound/anime/mp3/tympani-roll1.mp3");
        bgm.loop = true; bgm.volume = globalVol;
        bgm.play().catch(()=>{});
    } else {
        if(bgm) { bgm.pause(); bgm = null; }
        const a = new Audio("https://soundeffect-lab.info/sound/anime/mp3/jean1.mp3");
        a.volume = globalVol; a.play().catch(()=>{});
    }
}

async function spin() {
    if(spinning || items.length === 0) return;
    const unlock = new Audio(); unlock.play().then(()=>unlock.pause()).catch(()=>{});
    prevStr = tabs[curTabIdx].content;
    const isChaos = Math.random() < 0.2;
    currentCType = isChaos ? ['modal','ad','pixel','invert','fall','invisible','mojibake'][Math.floor(Math.random()*7)] : null;
    resetStyles();
    if(currentCType === 'modal') await startModalHell();
    if(currentCType === 'ad') document.getElementById('fakeAd').style.display = 'block';
    spinning = true;
    playS('roll');
    const winIdx = Math.floor(Math.random() * items.length);
    const arc = (Math.PI*2) / items.length;
    const rotations = 8 + Math.random() * 5; 
    const targetAng = (rotations * Math.PI * 2) + (1.5 * Math.PI - (winIdx * arc) - (arc / 2));
    let currentAng = 0;
    const start = performance.now();
    const duration = 5000;
    if(currentCType === 'invisible') document.getElementById('rCvs').classList.add('c-ghost');
    function animate(now) {
        const elapsed = now - start;
        const progress = Math.min(elapsed / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 4);
        currentAng = targetAng * ease;
        drawRoulette(currentAng);
        if (progress < 1) requestAnimationFrame(animate);
        else finalizeSpin(winIdx);
    }
    requestAnimationFrame(animate);
}

function finalizeSpin(winIdx) {
    spinning = false;
    let winItem = items[winIdx];
    const winColor = COLORS[winIdx % COLORS.length];
    
    if(currentCType === 'mojibake') winItem = "D@SI";
    if(currentCType === 'pixel') document.getElementById('rWrap').classList.add('c-pixel');
    if(currentCType === 'invert') document.body.classList.add('c-dark');
    if(currentCType === 'fall') document.getElementById('rWrap').classList.add('c-fall');

    document.getElementById('resText').innerText = winItem;
    document.body.style.background = `linear-gradient(to bottom, ${winColor} 0%, #ffffff 100%)`;
    
    playS('win');
    if(currentCType !== 'mojibake') { hist.unshift(winItem); if(hist.length>10) hist.pop(); renderHist(); }
}

function resetStyles() {
    const w = document.getElementById('rWrap'); w.className="r-wrap";
    document.getElementById('rCvs').className=""; document.body.classList.remove('c-dark');
    document.getElementById('fakeAd').style.display="none"; 
    document.body.style.background = "radial-gradient(circle, #ffffff 0%, #f0f2f5 100%)";
}

let shapes = [];
function initBg() {
    const c = document.getElementById('bgCanvas'); c.width = window.innerWidth; c.height = window.innerHeight;
    for(let i=0; i<40; i++) shapes.push({ 
        x: Math.random()*c.width, 
        y: Math.random()*c.height, 
        s: Math.random()*20+10, 
        sp: Math.random()*3 + 2,
        col: COLORS[Math.floor(Math.random()*COLORS.length)], 
        t: Math.floor(Math.random()*3) 
    });
    tick();
}
function tick() {
    const c = document.getElementById('bgCanvas'), ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    shapes.forEach(p => {
        p.y += p.sp; if(p.y > c.height) { p.y = -30; p.x = Math.random()*c.width; }
        ctx.fillStyle = p.col; ctx.globalAlpha = 0.6; ctx.beginPath();
        if(p.t===0) ctx.arc(p.x, p.y, p.s/2, 0, Math.PI*2);
        else if(p.t===1) ctx.fillRect(p.x, p.y, p.s, p.s);
        else { ctx.moveTo(p.x,p.y); ctx.lineTo(p.x+p.s, p.y+p.s); ctx.lineTo(p.x-p.s, p.y+p.s); ctx.closePath(); }
        ctx.fill();
    });
    requestAnimationFrame(tick);
}

function renderTabs() {
    const d = document.getElementById('tabs'); d.innerHTML = "";
    tabs.forEach((t,i) => {
        const div = document.createElement('div');
        div.className = `tab-item ${i===curTabIdx?'active':''}`;
        div.innerHTML = `<span onclick="setTab(${i})">${t.name}</span><span style="opacity:0.3; font-size:10px;" onclick="renTab(${i})">ç·¨é›†</span>`;
        d.appendChild(div);
    });
}
function setTab(i) { curTabIdx=i; renderTabs(); syncTab(); }
function renTab(i) { const n=prompt("åå‰:", tabs[i].name); if(n){tabs[i].name=n; renderTabs();} }
function renderHist() { const u = document.getElementById('histUl'); u.innerHTML=""; hist.forEach(h => { const l=document.createElement('li'); l.innerText=h; u.appendChild(l); }); }
function hardReset() { if(confirm("å…¨éƒ¨æ¶ˆã™ã‚ˆï¼Ÿ")){ tabs[curTabIdx].content=""; syncTab(); resetStyles(); } }
function undo() { if(prevStr){ tabs[curTabIdx].content=prevStr; syncTab(); } }

let mCount=0;
function startModalHell() {
    return new Promise(res => {
        mCount=0; document.getElementById('modalHell').style.display='flex';
        window.nextM = () => { mCount++; document.getElementById('mMsg').innerText="æœ¬å½“ã«ã„ã„ã§ã™ã‹ï¼Ÿ(" + mCount + "/5)"; if(mCount>=5){ document.getElementById('modalHell').style.display='none'; res(); } };
    });
}

// -------------------------------------------------------------------------
// ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šLZStringã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®ãƒ»è§£å‡ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
// -------------------------------------------------------------------------
function copyUrl() {
    // ãƒ‡ãƒ¼ã‚¿ã‚’åœ§ç¸®ã—ã¦EncodedURIComponentå½¢å¼ã«ã™ã‚‹
    const jsonStr = JSON.stringify({t:tabs, c:curTabIdx});
    const compressed = LZString.compressToEncodedURIComponent(jsonStr);
    
    // URLä½œæˆ
    const url = window.location.origin + window.location.pathname + "#" + compressed;
    
    // çŸ­ç¸®URLã‚µãƒ¼ãƒ“ã‚¹ã«é€šã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
    if (url.length > 2000) {
        alert("ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã™ãã¾ã™ï¼\nURLçŸ­ç¸®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ã«ã¯ã€é …ç›®ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚");
    } else {
        navigator.clipboard.writeText(url).then(() => {
            alert("çŸ­ç¸®ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\nã€æ¬¡ã®æ‰‹é †ã€‘\nã‚³ãƒ”ãƒ¼ã—ãŸURLã‚’çŸ­ç¸®ã‚µã‚¤ãƒˆï¼ˆis.gd ãªã©ï¼‰ã«\nè²¼ã‚Šä»˜ã‘ã¦çŸ­ç¸®ã—ã¦ãã ã•ã„ã€‚");
        });
    }
}

function loadHash() {
    try {
        if(window.location.hash){
            const hash = window.location.hash.slice(1);
            // ã¾ãšã¯æ–°ã—ã„åœ§ç¸®å½¢å¼ã§ã®è§£å‡ã‚’è©¦ã¿ã‚‹
            let decompressed = LZString.decompressFromEncodedURIComponent(hash);
            
            // è§£å‡ã§ããªã‹ã£ãŸå ´åˆï¼ˆå¤ã„URLã®å ´åˆï¼‰ã€ä»¥å‰ã®Base64å½¢å¼ã§è©¦ã™
            if (!decompressed) {
                decompressed = decodeURIComponent(atob(hash));
            }
            
            if (decompressed) {
                const d = JSON.parse(decompressed);
                tabs = d.t;
                curTabIdx = d.c;
            }
        }
    } catch(e) {
        console.log("URLèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: æ—§å½¢å¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™", e);
    }
}
</script>
</body>
</html>
