<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹å‘½ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒ»éŸ³é‡å›ºå®šç‰ˆ</title>
    <style>
        :root {
            --bg-grad: radial-gradient(circle, #ffffff 0%, #f8f9fa 100%);
            --text-color: #444;
            --p-red: #ffb3ba; --p-yellow: #ffffba; --p-orange: #ffdfba;
            --p-blue: #bae1ff; --p-purple: #e2baff; --p-green: #baffc9;
            --p-gray: #e0e0e0; --mint-active: #b2ffb2; --border-deep: #2e8b57;
        }
        * { box-sizing: border-box; }
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            margin: 0; padding: 0; background: var(--bg-grad); color: var(--text-color);
            overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center;
            transition: background 0.8s ease;
        }
        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .container { display: grid; grid-template-columns: 240px 1fr 240px; gap: 50px; width: 95%; max-width: 1400px; height: 85vh; position: relative; z-index: 1; }
        
        /* å·¦ãƒ‘ãƒãƒ« */
        .left-panel { display: flex; flex-direction: column; gap: 20px; justify-content: center; }
        .audio-box { border: 1px solid #ddd; padding: 15px; border-radius: 15px; background: rgba(255, 255, 255, 0.9); text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .vol-game { position: relative; height: 80px; border-bottom: 4px solid #666; margin-bottom: 10px; background: #fff; overflow: hidden; border-radius: 5px; }
        #volBall { width: 18px; height: 18px; background: #ff6b6b; border-radius: 50%; position: absolute; top: 0; left: 50%; display: none; z-index: 2; }
        .vol-indicator { font-size: 12px; margin-bottom: 5px; color: #888; }
        #currentVolDisp { font-weight: bold; color: #ff6b6b; }

        .tabs { display: flex; flex-direction: column; gap: 8px; }
        .tab-item { padding: 10px 15px; border: 1px solid var(--border-deep); background: white; cursor: pointer; border-radius: 8px; transition: 0.3s; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .tab-item.active { background-color: var(--mint-active); border-radius: 20px; border-color: transparent; font-weight: bold; }
        .sys-btns { display: flex; flex-direction: column; gap: 8px; }
        button { padding: 10px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-url { background: var(--p-blue); } .btn-reset { background: var(--p-red); } .btn-undo { background: var(--p-yellow); font-size: 11px; }

        /* ä¸­å¤® */
        .center-panel { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .res-display { font-size: 32px; font-weight: bold; margin-bottom: 15px; height: 40px; }
        .r-wrap { position: relative; margin-bottom: 25px; transition: transform 0.5s; }
        .needle { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 35px; z-index: 10; color: #444; }
        canvas#rCvs { border-radius: 50%; box-shadow: 0 15px 35px rgba(0,0,0,0.1); background: white; }
        #spinBtn { width: 180px; height: 50px; font-size: 20px; background: var(--p-green); margin-bottom: 15px; box-shadow: 0 4px 0 #88cc88; }
        textarea { width: 90%; height: 120px; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 14px; outline: none; background: rgba(255,255,255,0.7); }

        /* å³ãƒ‘ãƒãƒ« */
        .right-panel { display: flex; flex-direction: column; justify-content: center; }
        .hist-card { border: 1px solid #ffb3ba; border-radius: 25px; padding: 20px; height: 70%; background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; }
        .hist-title { text-align: center; color: #ff6b6b; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #ffeff0; }
        .hist-list { list-style: none; padding: 0; overflow-y: auto; flex: 1; font-size: 14px; }

        /* ã‚«ã‚ªã‚¹æ¼”å‡º */
        .c-dark { filter: invert(1) hue-rotate(180deg); background: #000 !important; }
        .c-pixel { image-rendering: pixelated; transform: scale(0.1) rotate(360deg); transition: 4s; }
        .c-fall { transform: translateY(150vh) rotate(30deg); transition: 1.2s; }
        #fakeAd { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 280px; height: 220px; background: yellow; border: 4px solid red; z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #modalHell { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div class="container">
    <div class="left-panel">
        <div class="audio-box">
            <div class="vol-indicator">ç¾åœ¨ã®éŸ³é‡: <span id="currentVolDisp">50%</span></div>
            <div class="vol-game" id="volGame"><div id="volBall"></div></div>
            <button onclick="dropBall()" style="background:#eee; width:100%;">ğŸ”Š éŸ³é‡å†æŠ½é¸</button>
            <button onclick="toggleMute()" style="background:#eee; width:100%; margin-top:5px;" id="muteBtn">ğŸ”‡ Mute: OFF</button>
        </div>
        <div class="tabs" id="tabs"></div>
        <div class="sys-btns">
            <button class="btn-url" onclick="copyUrl()">ğŸ”— URLã‚³ãƒ”ãƒ¼</button>
            <button class="btn-reset" onclick="hardReset()">âš ï¸ ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="btn-undo" onclick="undo()">â†©ï¸ Undo</button>
        </div>
    </div>

    <div class="center-panel">
        <div class="res-display" id="resText">READY</div>
        <div class="r-wrap" id="rWrap">
            <div class="needle">â–¼</div>
            <canvas id="rCvs" width="380" height="380"></canvas>
        </div>
        <button id="spinBtn" onclick="spin()">START</button>
        <textarea id="itemsArea" placeholder="æ”¹è¡Œã§å…¥åŠ›..."></textarea>
    </div>

    <div class="right-panel">
        <div class="hist-card">
            <div class="hist-title">HISTORY</div>
            <ul class="hist-list" id="histUl"></ul>
        </div>
    </div>
</div>

<div id="fakeAd"><span style="position:absolute; top:0; right:0; cursor:pointer; padding:5px;" onclick="this.parentElement.style.display='none'">[X]</span><b>é™å®šã‚»ãƒ¼ãƒ«</b><p>å½“é¸ç¢ºç‡UPä¸­ï¼</p><button style="background:red; color:white;">è©³ç´°</button></div>
<div id="modalHell"><div style="background:white; padding:30px; border-radius:15px; text-align:center;"><p id="mMsg">å›ã—ã¾ã™ã‹ï¼Ÿ</p><button onclick="nextM()">ã¯ã„</button></div></div>

<script>
const COLORS = ['#ffb3ba', '#ffffba', '#ffdfba', '#bae1ff', '#e2baff', '#baffc9', '#e0e0e0'];
let items = [], hist = [], prev = "", spinning = false, cType = null, bgm = null;
let tabs = [ { name: "ã‚¿ãƒ– 1", content: "ãƒ©ãƒ¼ãƒ¡ãƒ³\nã†ã©ã‚“\nã‚«ãƒ¬ãƒ¼\nãƒ‘ã‚¹ã‚¿" }, { name: "ã‚¿ãƒ– 2", content: "" }, { name: "ã‚¿ãƒ– 3", content: "" }, { name: "ã‚¿ãƒ– 4", content: "" }, { name: "ã‚¿ãƒ– 5", content: "" } ];
let curTab = 0;

// â˜…éŸ³é‡ç®¡ç†ï¼ˆåˆæœŸå€¤50%ï¼‰
let globalVol = 0.5; 
let isMuted = false;

window.onload = () => { loadHash(); renderTabs(); syncTab(); initBg(); updateVolDisp(); };

function syncTab() { document.getElementById('itemsArea').value = tabs[curTab].content; updateItems(); }
function updateItems() {
    items = document.getElementById('itemsArea').value.split('\n').filter(t => t.trim() !== "").slice(0, 500);
    tabs[curTab].content = document.getElementById('itemsArea').value;
    draw();
}
document.getElementById('itemsArea').addEventListener('input', updateItems);

function draw(offset = 0) {
    const cvs = document.getElementById('rCvs'), ctx = cvs.getContext('2d'), r = cvs.width / 2;
    ctx.clearRect(0,0,380,380);
    ctx.beginPath(); ctx.arc(r,r,r-5,0,7); ctx.fillStyle="#fff"; ctx.fill();
    ctx.lineWidth=6; ctx.strokeStyle="#ccc"; ctx.stroke();
    if(items.length === 0) return;
    const arc = (Math.PI*2) / items.length;
    items.forEach((txt, i) => {
        const ang = offset + (i * arc);
        ctx.beginPath(); ctx.moveTo(r,r); ctx.arc(r,r,r-8,ang,ang+arc);
        ctx.fillStyle = COLORS[i % COLORS.length]; ctx.fill();
        ctx.save(); ctx.translate(r,r); ctx.rotate(ang + arc/2); ctx.textAlign="right"; ctx.fillStyle="#444";
        ctx.font="bold 16px sans-serif"; ctx.fillText(txt.length > 8 ? txt.slice(0,7)+'..' : txt, r-25, 5); ctx.restore();
    });
}

// éŸ³é‡æŠ½é¸
function dropBall() {
    const b = document.getElementById('volBall'); b.style.display="block"; b.style.top="0";
    b.style.left = Math.random() * 80 + 10 + "%";
    let y=0, s=1;
    const itv = setInterval(()=>{
        y+=s; s+=0.8; b.style.top=y+'px';
        if(y>65) { 
            clearInterval(itv); 
            // ãƒœãƒ¼ãƒ«ã®è½ã¡ãŸä½ç½®(å·¦å³)ã§æ±ºã‚ã‚‹ã®ã§ã¯ãªãã€å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªæŠ½é¸
            globalVol = Math.random(); 
            updateVolDisp();
            // æŠ½é¸ç›´å¾Œã«ç¢ºèªéŸ³ã‚’é³´ã‚‰ã™
            playS('win');
        }
    },20);
}

function updateVolDisp() {
    const disp = Math.round(globalVol * 100);
    document.getElementById('currentVolDisp').innerText = disp + "%";
}

function toggleMute() {
    isMuted = !isMuted;
    document.getElementById('muteBtn').innerText = isMuted ? "ğŸ”‡ Mute: ON" : "ğŸ”‡ Mute: OFF";
}

// ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿ (ã‚­ãƒ¼ãƒ—ã•ã‚ŒãŸglobalVolã‚’ä½¿ç”¨)
function playS(t) {
    if(isMuted) return;
    const currentAudioVol = (cType === 'loud') ? 1.0 : globalVol;

    if(t === 'roll') {
        if(bgm) bgm.pause();
        bgm = new Audio("https://soundeffect-lab.info/sound/anime/mp3/tympani-roll1.mp3");
        bgm.loop = true; 
        bgm.volume = currentAudioVol;
        bgm.play().catch(e => console.log("å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»é¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚"));
    } else {
        if(bgm) { bgm.pause(); bgm = null; }
        const jean = "https://soundeffect-lab.info/sound/anime/mp3/jean1.mp3";
        const others = ["https://soundeffect-lab.info/sound/anime/mp3/trumpet2.mp3","https://soundeffect-lab.info/sound/anime/mp3/shine3.mp3","https://soundeffect-lab.info/sound/anime/mp3/tin1.mp3"];
        const url = (Math.random() < 0.8) ? jean : others[Math.floor(Math.random()*3)];
        const a = new Audio(url);
        a.volume = currentAudioVol;
        a.play().catch(e => console.log("å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚"));
    }
}

async function spin() {
    if(spinning || items.length === 0) return;
    prev = tabs[curTab].content;
    const isChaos = Math.random() < 0.2;
    cType = isChaos ? pickC() : null;

    resetStyles();
    if(cType === 'modal') await startM();
    if(cType === 'ad') document.getElementById('fakeAd').style.display = 'flex';

    spinning = true;
    playS('roll');

    const winIdx = Math.floor(Math.random() * items.length);
    const arc = (Math.PI*2) / items.length;
    const rotations = 6 + Math.random() * 4;
    const targetAng = (rotations * Math.PI * 2) + (1.5 * Math.PI - (winIdx * arc) - (arc / 2));
    
    let currentAng = 0;
    const startTime = performance.now();
    const duration = 5000;

    function animate(now) {
        const elapsed = now - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        currentAng = targetAng * easeOut;
        draw(currentAng);
        if (progress < 1) requestAnimationFrame(animate);
        else stopSpin(currentAng, winIdx);
    }
    requestAnimationFrame(animate);
}

function stopSpin(finalAng, winIdx) {
    spinning = false;
    let win = items[winIdx];
    if(cType === 'mojibake') win = "â–¯â–¯â–¯â–¯";
    if(cType === 'pixel') document.getElementById('rWrap').classList.add('c-pixel');
    if(cType === 'invert') document.body.classList.add('c-dark');
    if(cType === 'fall') document.getElementById('rWrap').classList.add('c-fall');

    document.getElementById('resText').innerText = win;
    document.body.style.background = COLORS[winIdx % COLORS.length];
    playS('win');
    if(cType !== 'mojibake') { hist.unshift(win); if(hist.length>10) hist.pop(); renderHist(); }
}

// å…±é€šãƒ‘ãƒ¼ãƒ„
function renderTabs() {
    const d = document.getElementById('tabs'); d.innerHTML = "";
    tabs.forEach((t,i) => {
        const div = document.createElement('div');
        div.className = `tab-item ${i===curTab?'active':''}`;
        div.innerHTML = `<span onclick="setTab(${i})">${t.name}</span><span style="font-size:10px; opacity:0.3;" onclick="renTab(${i})">ç·¨é›†</span>`;
        d.appendChild(div);
    });
}
function setTab(i) { curTab=i; renderTabs(); syncTab(); }
function renTab(i) { const n=prompt("åå‰:", tabs[i].name); if(n){tabs[i].name=n; renderTabs();} }
function renderHist() { const u = document.getElementById('histUl'); u.innerHTML=""; hist.forEach(h => { const l=document.createElement('li'); l.innerText=h; u.appendChild(l); }); }
function hardReset() { if(confirm("æ¶ˆå»?")){ tabs[curTab].content=""; syncTab(); resetStyles(); } }
function undo() { if(prev){ tabs[curTab].content=prev; syncTab(); } }
function pickC() { return ['modal','ad','pixel','invert','fall','invisible','mojibake','loud'][Math.floor(Math.random()*8)]; }
function resetStyles() {
    const w = document.getElementById('rWrap'); w.className="r-wrap";
    document.getElementById('rCvs').className=""; document.body.classList.remove('c-dark');
    document.getElementById('fakeAd').style.display="none"; document.body.style.background = "var(--bg-grad)";
}
let mCount=0;
function startM() {
    return new Promise(res => {
        mCount=0; document.getElementById('modalHell').style.display='flex';
        window.nextM = () => { mCount++; document.getElementById('mMsg').innerText="ã„ã„ã§ã™ã‹ï¼Ÿ(" + mCount + "/5)"; if(mCount>=5){ document.getElementById('modalHell').style.display='none'; res(); } };
    });
}
function copyUrl() {
    const b64 = btoa(encodeURIComponent(JSON.stringify({t:tabs, c:curTab})));
    window.location.hash = b64; navigator.clipboard.writeText(window.location.href); alert("URL Copy! ğŸ”—");
}
function loadHash() { try { if(window.location.hash){ const d = JSON.parse(decodeURIComponent(atob(window.location.hash.slice(1)))); tabs=d.t; curTab=d.c; } } catch(e){} }

// èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡
let shps = [];
function initBg() {
    const c = document.getElementById('bgCanvas'); c.width = window.innerWidth; c.height = window.innerHeight;
    for(let i=0; i<30; i++) shps.push({ x: Math.random()*c.width, y: Math.random()*c.height, s: Math.random()*20+5, sp: Math.random()*1+0.2, col: COLORS[Math.floor(Math.random()*7)], t: Math.floor(Math.random()*3) });
    anim();
}
function anim() {
    const c = document.getElementById('bgCanvas'), ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    shps.forEach(p => {
        p.y += p.sp; if(p.y > c.height) p.y = -20;
        ctx.fillStyle = p.col; ctx.globalAlpha = 0.4; ctx.beginPath();
        if(p.t===0) ctx.arc(p.x, p.y, p.s, 0, 7);
        else if(p.t===1) ctx.fillRect(p.x, p.y, p.s, p.s);
        else { ctx.moveTo(p.x,p.y); ctx.lineTo(p.x+p.s, p.y+p.s); ctx.lineTo(p.x-p.s, p.y+p.s); }
        ctx.fill();
    });
    requestAnimationFrame(anim);
}
</script>
</body>
</html>
