<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹å‘½ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒ»ã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ãƒƒãƒˆ EX</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        :root {
            --bg-grad: linear-gradient(to bottom, #ffffff 0%, #f0f2f5 100%);
            --p-red: #ffb3ba; --p-yellow: #ffffba; --p-orange: #ffdfba;
            --p-blue: #bae1ff; --p-purple: #e2baff; --p-green: #baffc9;
            --p-gray: #e0e0e0; --mint-active: #b2ffb2; --border-deep: #2d5a27;
        }
        * { box-sizing: border-box; }
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            margin: 0; padding: 0; background: var(--bg-grad); color: #333;
            overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center;
            transition: background 1.2s ease;
        }
        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

        .container {
            display: grid; grid-template-columns: 240px 1fr 240px; gap: 40px;
            width: 95%; max-width: 1400px; height: 90vh; position: relative; z-index: 1;
        }

        /* å·¦ãƒ‘ãƒãƒ«: éŸ³é‡ãƒ»ã‚¿ãƒ–ãƒ»ãƒœã‚¿ãƒ³ */
        .left-panel { display: flex; flex-direction: column; gap: 20px; justify-content: center; }
        .audio-box {
            border: 1px solid #ddd; padding: 15px; border-radius: 15px; background: rgba(255, 255, 255, 0.9);
            text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .vol-game {
            position: relative; height: 80px; border-bottom: 3px solid #ccc; margin-bottom: 10px;
            background: #fff; overflow: hidden; border-radius: 5px;
        }
        #volBall { width: 18px; height: 18px; background: #ff6b6b; border-radius: 50%; position: absolute; top: 0; left: 50%; display: none; }
        .vol-info { font-size: 11px; color: #888; margin-bottom: 5px; }
        #volText { font-weight: bold; color: #4a90e2; font-size: 16px; }

        .tabs { display: flex; flex-direction: column; gap: 8px; }
        .tab-item {
            padding: 12px; border: 1px solid var(--border-deep); background: white; cursor: pointer;
            border-radius: 5px; transition: 0.3s; display: flex; justify-content: space-between; font-size: 13px;
        }
        .tab-item.active { background-color: var(--mint-active); border-radius: 15px; border-width: 2px; font-weight: bold; transform: scale(1.03); }
        .tab-name { flex: 1; }
        .tab-edit { opacity: 0.3; font-size: 10px; margin-left: 5px; }

        .sys-btns { display: flex; flex-direction: column; gap: 10px; }
        button { padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.95); }
        .btn-url { background: var(--p-blue); color: #333; }
        .btn-reset { background: var(--p-red); color: #333; }
        .btn-undo { background: var(--p-yellow); font-size: 11px; }

        /* ä¸­å¤®ãƒ‘ãƒãƒ«: ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ */
        .center-panel { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .res-display { font-size: 38px; font-weight: bold; margin-bottom: 15px; height: 50px; text-align: center; color: #333; text-shadow: 0 0 15px rgba(255,255,255,1); }
        .r-wrap { position: relative; margin-bottom: 25px; transition: transform 0.5s, filter 0.3s; }
        .needle { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 50px; z-index: 10; color: #ff4444; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
        canvas#rCvs { border-radius: 50%; box-shadow: 0 15px 50px rgba(0,0,0,0.1); background: white; }
        #spinBtn { width: 240px; height: 65px; font-size: 26px; background: #66cc66; color: white; border-bottom: 5px solid #44aa44; margin-bottom: 20px; z-index: 10; }
        textarea {
            width: 100%; height: 120px; padding: 15px; border: 1px solid #ddd; border-radius: 15px;
            font-size: 15px; background: rgba(255,255,255,0.85); resize: none; outline: none; transition: 0.3s;
        }
        textarea:focus { border-color: #aaa; background: #fff; }

        /* å³ãƒ‘ãƒãƒ«: å±¥æ­´ */
        .right-panel { display: flex; flex-direction: column; justify-content: center; }
        .hist-card {
            border: 1px solid #ffcccc; border-radius: 20px; padding: 20px; height: 80%;
            background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(255,0,0,0.05);
        }
        .hist-title { text-align: center; color: #ff6666; font-size: 12px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #ffeeee; }
        .hist-list { list-style: none; padding: 0; overflow-y: auto; flex: 1; margin: 0; }
        .hist-list li { padding: 10px; border-bottom: 1px solid #fff5f5; font-size: 15px; text-align: center; animation: slideIn 0.4s ease-out; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* ç‰¹æ®Šæ¼”å‡ºã‚¹ã‚¿ã‚¤ãƒ« */
        .c-dark { filter: invert(1) hue-rotate(180deg); background: #000 !important; }
        .c-pixel { image-rendering: pixelated; transform: scale(0.2); transition: 4s linear; }
        .c-fall { transform: translateY(120vh) rotate(45deg) !important; transition: 2s ease-in !important; }
        .c-ghost { opacity: 0 !important; }
        #fakeAd { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 350px; padding: 30px; background: #fffb00; border: 8px solid red; z-index: 9999; display: none; text-align: center; box-shadow: 20px 20px 0 black; cursor: pointer; }
        #modalHell { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; justify-content: center; align-items: center; }
        .flash-white { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10001; animation: flashAnim 2s forwards; }
        @keyframes flashAnim { from {opacity:1} to {opacity:0} }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div class="container">
    <div class="left-panel">
        <div class="audio-box">
            <div class="vol-info">éŸ³é‡è¨­å®š: <span id="volText">50%</span></div>
            <div class="vol-game" id="volGame"><div id="volBall"></div></div>
            <button onclick="dropBall()" style="background:#eee; width:100%; margin-bottom:5px;">ğŸ”Š çƒã‚’è½ã¨ã—ã¦éŸ³é‡æŠ½é¸</button>
            <button onclick="toggleMute()" id="muteBtn" style="background:#fff; border:1px solid #ddd; width:100%;">ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ: OFF</button>
        </div>
        <div class="tabs" id="tabs"></div>
        <div class="sys-btns">
            <button class="btn-url" onclick="copyUrl()">ğŸ”— ä¿å­˜ãƒ»URLç™ºè¡Œ (ã‚³ãƒ”ãƒ¼)</button>
            <button class="btn-reset" onclick="hardReset()">âš ï¸ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="btn-undo" onclick="undo()" id="undoBtn" style="display:none;">â†©ï¸ æ¶ˆã™å‰ã®å˜èªã‚’æˆ»ã™</button>
        </div>
    </div>

    <div class="center-panel">
        <div class="res-display" id="resText">READY</div>
        <div class="r-wrap" id="rWrap">
            <div class="needle" id="needle">â–¼</div>
            <canvas id="rCvs" width="450" height="450"></canvas>
        </div>
        <button id="spinBtn" onclick="trySpin()">START</button>
        <textarea id="itemsArea" placeholder="ã“ã“ã«å˜èªã‚’æ”¹è¡Œã§å…¥åŠ›..."></textarea>
    </div>

    <div class="right-panel">
        <div class="hist-card">
            <div class="hist-title">HISTORY (10)</div>
            <ul class="hist-list" id="histUl"></ul>
        </div>
    </div>
</div>

<div id="fakeAd" onclick="this.style.display='none'">
    <div style="font-size:40px; position:absolute; top:-20px; right:-20px; background:red; color:white; width:60px; height:60px; border-radius:50%; line-height:60px;">Ã—</div>
    <b style="font-size:24px;">âš ï¸ å½“é¸ç¢ºç‡1000% UPï¼ âš ï¸</b><br><p>ä»Šã™ãã‚¯ãƒªãƒƒã‚¯ã—ã¦è±ªè¯è³å“ã‚’ã‚²ãƒƒãƒˆï¼<br>(â€»å˜˜ã§ã™)</p>
</div>
<div id="modalHell">
    <div style="background:white; padding:40px; border-radius:25px; text-align:center;">
        <p id="mMsg" style="font-size:22px; font-weight:bold;">å¾Œæ‚”ã—ã¾ã›ã‚“ã‹ï¼Ÿ</p>
        <button onclick="nextM()" style="font-size:20px; padding:15px 40px; background:red; color:white;">ã¯ã„</button>
    </div>
</div>

<script>
// å®šæ•°ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿
const COLORS = ['#ffb3ba', '#ffffba', '#ffdfba', '#bae1ff', '#e2baff', '#baffc9', '#e0e0e0'];
const DEFAULT_WORDS = `ã‚ã‚‹æ—¥\nå††æŸ±\nç”·\nå‚˜\nã‚«ãƒ©ã‚¹\nã‚ã‹ã‚é ­\nã‚ãŸã„\nå…¨è‡ªå‹•ãŸã¾ã”ç„¼ãæ©Ÿï¼ˆè‡ªèµ°å¼ï¼‰\nãƒãƒ¯ãƒ¯\nã‚´ãƒªãƒ©\nå¤§æ ¹\næ„è­˜é«˜ã„ç³»\nã‚»ãƒŸ\nã‚«ãƒã‚­ãƒª\nãƒ¬ã‚¿ã‚¹\nãƒ¤ã‚®\nã‚¯ãƒ©ã‚²\nå°±æ´»ä¸­\nãƒ–ãƒ©ãƒƒã‚¯ä¼æ¥­æˆ¦å£«\nã‚°ãƒ©ã‚µãƒ³\nç´è±†\nãƒ¢ã‚¢ã‚¤åƒ\nã‚³ãƒ³ã‚»ãƒ³ãƒˆ\nç‹‚äºº\nã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«\nãµã™ã¾\næ¥ãšã‹ã‚Šå±‹\nä¿¡å·æ©Ÿ\næ¨ªæ–­é“\nå›½é“\nè‡ªæ„è­˜éå‰°\nã‚µãƒ³ãƒ€ãƒ«\nç”»é‹²\nã¡ã‚Šç®±\nè›‡å£\nå¿è€…\nå®šè¦\næ–‡æˆ¿å…·ãŸã¡\nè€³ã‹ã\nå®‡å®™\nå¤ªé™½\nç©ºæ°—æ´—æµ„æ©Ÿ\nãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒˆ\nã‚¹ãƒ«ãƒ¡\nãŸãã‚ã‚“\nçŸ³ã“ã‚\næ­£è«–\nãƒ¡ãƒ­ãƒ³ãƒ‘ãƒ³\nãƒãƒ³ã‚³ãƒ„\nè¶…æ–°æ˜Ÿ\nã“ã‚“ã«ã‚ƒã\nã¡ãã‚\nãµã‚Šã‹ã‘\nç³¸ã‚ˆã†ã˜\nçµµæœ¬\nãƒã‚·ãƒ¥ãƒãƒ­\nä¼èª¬ã®\nè€³ãŸã¶\nãŠã«ãã‚Š\nã‚¹ãƒªãƒƒãƒ‘\nå³¶ãã†ã‚Š\nã‚³ãƒ­ãƒƒã‚±\nã‚¿ãƒ”ã‚ªã‚«\næè±†\nã‚ãŸã‚ã‚\nç„¡æ•µ\nç„¡åŒ\nå¥½å¥‡å¿ƒ\nåŸ·å¿µ\nãƒã‚¹\nãƒãƒ–\nãƒãƒ³ã‚°ãƒ¼ã‚¹\nä»²é–“å‰²ã‚Œã—ãŸ\nã‚¿ãƒ¯ã‚·\nç´è±†ã®ç³¸\nãŠéš£ã•ã‚“\nç„¡æ©Ÿè³ªãªæ„›\næ¹¿ã£ãŸ\nãƒ‘ãƒ³ã®è€³\næ¦‚å¿µ\nå…¨è‡ªå‹•è¬ç½ªæ©Ÿ\nå®‡å®™ã®ã‚´ãƒŸ\nãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹\nè¦ªçŸ¥ã‚‰ãš\nå¼•ãå­ã•ã‚“\nã¬ã‚‹ã¾æ¹¯\næ±ºæ„\nå¾®ã‹ãªå¸Œæœ›\nçµ¶æœ›çš„\nä½æ°—åœ§\nã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ã€ŒF5ã€\næœªç¢ºèª\né ˜åæ›¸\nä½¿ã„å¤ã—ãŸ\næ¼‚ã†\næ°—é…\næ˜¨å¤œã®è¨˜æ†¶\nè™šç„¡\nè³å‘³æœŸé™åˆ‡ã‚Œ\næ­£ç¾©\nä½åç™º\né­‚\nè¿·å­ã«ãªã£ãŸ\nãƒ—ãƒ©ã‚¤ãƒ‰\né‡åŠ›\næ˜¨æ—¥\næ˜¼é£¯\néš£ã«ã„ãŸ\nå¹½éœŠ\nä¸æ¡ç”¨\né€šçŸ¥\nå¯ä¸è¶³\nç¥æ§˜\nåŠé€æ˜\né‡æœ›\nå……é›»1%\nå‹‡æ°—\nã‚«ãƒ“\nç†æƒ³\nåŸƒ\nè¢«ã£ãŸ\né‡å¿ƒ\næ¿¡ã‚ŒãŸ\nçŠ¬\nåŒ‚ã„\nåæŠ—æœŸ\né›»å­ãƒ¬ãƒ³ã‚¸\nå†·ã‚ãŸãƒ”ã‚¶\nè¬ã®ç”Ÿå‘½ä½“\nå±¥æ­´æ›¸\nå¥¥ã®é´ä¸‹\nå­˜åœ¨ã—ãªã„\nè¨˜æ†¶\nåœŸä¿µéš›\næ„åœ°\né€ƒã’å‡ºã—ãŸ\nèªå½™åŠ›\ä¸­å¤\nè‰¯å¿ƒ\næ ¹æ€§\nè§£é‡ˆé•ã„\nç¾å®Ÿ\nä¸å¯é¿\né‹å‘½\næœŸé™åˆ‡ã‚Œãƒã‚±ãƒƒãƒˆ\nèª°ã‹ã®\nå¿˜ã‚Œç‰©\næ˜æ—¥\nä¸å®‰\né›¨\n2ã€œ3å¹´\nè‡ªç„¶ç½å®³\né–€\nå¾Œã‚\nãŸãã•ã‚“\nï¼ï¼ï¼ï¼ï¼\nãƒã‚¢\né£²é£Ÿ\nWi-Fi\nä¸‰è§’ã‚³ãƒ¼ãƒ³\nã¤ã®\nã‚·ãƒ£ãƒ¼ãƒšãƒ³\nãƒãƒ¼ãƒˆ\næ—¥ã‚ãã‚Šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼\næ„æ€\nå¿ƒ\nãƒ¡ãƒ¢\nå¤©æ°—\nãƒãƒƒã‚¹ãƒ«\nè¦ªæŒ‡ã®çˆª\nã§ã‚„ã‚“ã™\nåœ§å€’çš„\næ³¥\nãƒãƒ¯ãƒ¯ã®è„±æ¯›\nã‚³ãƒ³ã‚¯ãƒªå‘³\né€†ç«‹ã¡\nå¯Œå£«å±±\næ—¥æœ¬åˆ—å³¶\nå°–é–£è«¸å³¶\næ²–ãƒé³¥å³¶\nãƒã‚«ãƒ­ãƒ³\nèƒŒè² ã†\nåœ°çƒ\nç´ æ‰‹\nå‰²ã‚‹\nãƒ”ã‚¹ã‚¿ãƒã‚ª\næ–­æœ«é­”\nå«ã³\nè¶…éŸ³æ³¢\nç™ºã›ã‚‰ã‚Œã‚‹\nãƒŒãƒ¡ã‚‹\nå“²å­¦\nã‚¤ãƒ¤ãƒ›ãƒ³\nè†ã®çš¿\nãƒ‘ãƒ³ã‚±ãƒ¼ã‚­\nç„¼ã\nè’¸ã™\nç…®ã‚‹\nãƒ¬ãƒ³ãƒãƒ³\nãƒãƒªã‚¢ãƒŠæµ·æº\nã‚¨ãƒ™ãƒ¬ã‚¹ãƒˆ\nè¿·å­\nã‚¤ã‚«å¢¨\nä¸‰è¶³æ­©è¡Œ\nã—ã˜ã¿\né€†ã‚®ãƒ¬\nåŠ±ã‚€\nè²¯é‡‘\nç¤¾äº¤çš„\nå¾…ã¤\nç„¼è‚‰\nè†\nç¬‘ã†\nåæŠ—æœŸ\næ‚Ÿã‚Šã‚’é–‹ã„ãŸ\nå®…é…ä¾¿\nã‚¦ãƒ¼ãƒãƒ¼\nå¼¾ã\nå¾¹å¤œæ˜ã‘\nç‹¬ã‚Šè¨€\nç­‹ãƒˆãƒ¬\nè±†è…\nè‡ªæ’®ã‚Š\nå–‹ã‚‹\næ¶™ã‚‚ã‚ã„\næ€’ã‚Šç‹‚ã†\nå…¥æœ­ã—ãŸ\nè¸Šã‚‹\nç©ºé£›ã¶\né™ç•Œã‚’è¿ãˆã‚‹\nå¤¢ã‚’ã¿ã‚‹\næ¥½å™¨\nå–§å˜©ã‚’ã™ã‚‹\næ‹\nè½ã¡ã‚‹\næ—…ã«å‡ºã‚‹\næ­Œã†\næ†§ã‚Œ\nç„¡é…¸ç´ \nç„¡é‡åŠ›\nè™›ç©º\nã‚¸ãƒ£ãƒ³ãƒ—\nå‡ºã‚‹\nç›®ã®å‰\næ´—é¡”\nã‚µãƒ³ãƒ\nå¯¾è«‡\nå…‰åˆæˆ\nç ‚æ¼ \näºŒåº¦è¦‹\n5åº¦æ¼¬ã‘\nè¨±ã•ãªã„\nä½åç™º\næ•\né«˜åç™º\n4æ¬¡å…ƒ\néå»å½¢\nã‚«ã‚µã‚«ã‚µ\nå‹æƒ…\né¨’ãŒã—ã„\næ²ˆé»™\nç”˜é…¸ã£ã±ã„\né‰„æ ¼å­ã®å‘³\nã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼ãª\nèª¬æ•™\nè™¹è‰²\né¼»è©°ã¾ã‚Š\né ­ç—›\nã‚ªãƒ³ãƒ‘ãƒ¬ãƒ¼ãƒ‰\né¦™ã°ã—ã„\né€æ˜\nå­˜åœ¨\nã‚´ãƒ„ã‚´ãƒ„\næƒ…ç†±\næ¹¿ã‚‹\nç²˜ã‚Šæ°—\nåœŸä¸‹åº§\nè¼ã\nç†ä¸å°½\nãƒªãƒ ã‚¸ãƒ³\nçˆ†ç™º\né™å¯‚\nå¼·ã„\nå¼±ã„\næœ€å¼·ã®\næœ€å¼±ã®\né‹­åˆ©\néˆæ„Ÿ\næ„Ÿå—æ€§è±Šã‹\nã‚¸ã‚§ãƒƒãƒˆã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼\næ¥µå°\nå¾®å¡µåˆ‡ã‚Š\nå·¨å¤§ãª\nä¸­é€”åŠç«¯\nç¥è©±\nä¸–ç´€æœ«\næœã”ã¯ã‚“\né‰„å£\né­…æƒ‘\nç¦æ–­ã®\nå‘ªã‚ã‚ŒãŸ\næ¼†é»’\nç´”ç™½\nç¼ç†±\nå®‡å®™è¦æ¨¡\nã†ã£ã‹ã‚Š\nã‚·ãƒ£ã‚­ã‚·ãƒ£ã‚­\nã‹ãæ°·\nèŠ±ç«\néŠ€æ²³ç³»\nå¿˜ã‚Œç‰©\nè¶…ãˆã‚‹\næ¦‚å¿µ\nç‰©ç†æ³•å‰‡\nç„¡è¦–\nèŒ¶ç¢—è’¸ã—\næ„Ÿæƒ…ãªã—\né©å‘½çš„\nè²§å¼±\nè„†ã™ãã‚‹\nå±ã†ã„\nè¡Œå‹•\nå‘¨å›\næœ€çµ‚\nvs\né¼“è†œç ´ã‚Š\nå‘¼ã¶\né€†è¥²\næ¸¡ã‚‹\nçˆ†èµ°\nãƒ©ãƒƒãƒ‘ãƒ¼\nã‚³ã‚¹ãƒ—ãƒ¬\nå¤‰ãªå‘³`;

// çŠ¶æ…‹ç®¡ç†
let items = [], hist = [], spinning = false, currentEvent = null, bgm = null;
let tabs = [{name: "ã‚¿ãƒ– 1", content: DEFAULT_WORDS}, {name: "ã‚¿ãƒ– 2", content: ""}, {name: "ã‚¿ãƒ– 3", content: ""}, {name: "ã‚¿ãƒ– 4", content: ""}, {name: "ã‚¿ãƒ– 5", content: ""}];
let curTabIdx = 0, globalVol = 0.5, isMuted = false, undoContent = "";
let clickCount = 0;

window.onload = () => { loadUrl(); renderTabs(); syncTab(); initBg(); updateVolDisp(); };

// --- ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½ ---
function syncTab() { document.getElementById('itemsArea').value = tabs[curTabIdx].content; updateItems(); }
function updateItems() {
    const val = document.getElementById('itemsArea').value;
    items = val.split('\n').filter(t => t.trim() !== "").slice(0, 500);
    tabs[curTabIdx].content = val;
    drawRoulette();
}
document.getElementById('itemsArea').addEventListener('input', updateItems);

function renderTabs() {
    const d = document.getElementById('tabs'); d.innerHTML = "";
    tabs.forEach((t, i) => {
        const div = document.createElement('div');
        div.className = `tab-item ${i === curTabIdx ? 'active' : ''}`;
        div.innerHTML = `<span class="tab-name" onclick="setTab(${i})">${t.name}</span><span class="tab-edit" onclick="editTabName(${i})">ç·¨é›†</span>`;
        d.appendChild(div);
    });
}
function setTab(i) { curTabIdx = i; renderTabs(); syncTab(); }
function editTabName(i) { const n = prompt("ã‚¿ãƒ–ã®åå‰:", tabs[i].name); if (n) { tabs[i].name = n; renderTabs(); } }

function hardReset() {
    if (confirm("æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
        undoContent = tabs[curTabIdx].content;
        document.getElementById('undoBtn').style.display = "block";
        tabs[curTabIdx].content = ""; syncTab();
    }
}
function undo() { tabs[curTabIdx].content = undoContent; syncTab(); document.getElementById('undoBtn').style.display = "none"; }

// --- éŸ³é‡æŠ½é¸ã‚²ãƒ¼ãƒ  ---
function dropBall() {
    const b = document.getElementById('volBall'); b.style.display = "block"; b.style.top = "0";
    const x = Math.random() * 80 + 10; b.style.left = x + "%";
    let y = 0, spd = 1;
    const itv = setInterval(() => {
        y += spd; spd += 0.8; b.style.top = y + "px";
        if (y > 60) {
            clearInterval(itv); globalVol = x / 100; updateVolDisp();
            const a = new Audio("https://soundeffect-lab.info/sound/anime/mp3/win-marimba1.mp3");
            a.volume = globalVol; a.play().catch(()=>{});
        }
    }, 25);
}
function updateVolDisp() { document.getElementById('volText').innerText = Math.round(globalVol * 100) + "%"; }
function toggleMute() { isMuted = !isMuted; document.getElementById('muteBtn').innerText = isMuted ? "ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ: ON" : "ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ: OFF"; }

// --- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæç”» ---
function drawRoulette(offset = 0, isGhost = false) {
    const cvs = document.getElementById('rCvs'), ctx = cvs.getContext('2d'), r = cvs.width / 2;
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    if (items.length === 0) return;

    const arc = (Math.PI * 2) / items.length;
    items.forEach((txt, i) => {
        const ang = offset + (i * arc);
        ctx.beginPath(); ctx.moveTo(r, r); ctx.arc(r, r, r - 10, ang, ang + arc);
        ctx.fillStyle = COLORS[i % COLORS.length]; ctx.fill();
        ctx.lineWidth = 2; ctx.strokeStyle = "white"; ctx.stroke();
        
        ctx.save(); ctx.translate(r, r); ctx.rotate(ang + arc / 2);
        ctx.textAlign = "right"; ctx.fillStyle = isGhost ? "transparent" : "#333";
        ctx.font = "bold 14px sans-serif";
        ctx.fillText(txt.slice(0, 10), r - 30, 5); ctx.restore();
    });
    // æ 
    ctx.beginPath(); ctx.arc(r, r, r - 5, 0, Math.PI * 2); ctx.lineWidth = 10; ctx.strokeStyle = "#e0e0e0"; ctx.stroke();
}

// --- å›è»¢ãƒ­ã‚¸ãƒƒã‚¯ & ã‚¤ãƒ™ãƒ³ãƒˆ ---
async function trySpin() {
    if (spinning || items.length === 0) return;

    // 20%ã§ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
    currentEvent = Math.random() < 0.2 ? Math.floor(Math.random() * 25) : null;
    
    // UIå«ŒãŒã‚‰ã›
    if (currentEvent === 15) { // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåœ°ç„
        for(let i=0; i<5; i++) if(!confirm("å¾Œæ‚”ã—ã¾ã›ã‚“ã‹ï¼Ÿ")) return;
    }
    if (currentEvent === 16) { // ã‚¯ãƒªãƒƒã‚¯é€£æ‰“
        clickCount = 0;
        const btn = document.getElementById('spinBtn');
        btn.innerText = "é€£æ‰“ï¼ï¼(0/50)";
        return; 
    }

    startSpin();
}

// ã‚¯ãƒªãƒƒã‚¯é€£æ‰“ç”¨
document.getElementById('spinBtn').addEventListener('click', () => {
    if (clickCount >= 0 && clickCount < 50) {
        clickCount++;
        document.getElementById('spinBtn').innerText = `é€£æ‰“ï¼ï¼(${clickCount}/50)`;
        if (clickCount === 50) { clickCount = -1; document.getElementById('spinBtn').innerText = "START"; startSpin(); }
    }
});

async function startSpin() {
    spinning = true; resetStyles();
    const btn = document.getElementById('spinBtn'); btn.disabled = true;

    // éŸ³é‡é€†è»¢
    let playVol = globalVol;
    if (currentEvent === 20) playVol = 0.7;

    // éŸ³å£°
    if (!isMuted) {
        bgm = new Audio("https://soundeffect-lab.info/sound/anime/mp3/tympani-roll1.mp3");
        bgm.loop = true; bgm.volume = playVol; bgm.play().catch(()=>{});
    }

    const winIdx = Math.floor(Math.random() * items.length);
    const arc = (Math.PI * 2) / items.length;
    let rotations = 10 + Math.random() * 10;
    let duration = 5000;

    if (currentEvent === 0) duration = 1000; // æ€¥åœæ­¢

    const targetAng = (rotations * Math.PI * 2) + (1.5 * Math.PI - (winIdx * arc) - (arc / 2));
    const start = performance.now();

    function animate(now) {
        let elapsed = now - start;
        let progress = Math.min(elapsed / duration, 1);
        let ease = 1 - Math.pow(1 - progress, 4);
        
        let currentAng = targetAng * ease;

        // ç‰¹æ®ŠæŒ™å‹•
        if (currentEvent === 2) currentAng = -currentAng; // é€†å™´å°„
        if (currentEvent === 18) drawRoulette(currentAng, true); // é€æ˜åŒ–
        else drawRoulette(currentAng);

        if (currentEvent === 17) document.getElementById('fakeAd').style.display = 'block'; // åºƒå‘Š
        if (currentEvent === 21) document.getElementById('rWrap').style.filter = `blur(${progress*10}px)`; // ä½è§£åƒåº¦

        if (progress < 1) {
            requestAnimationFrame(animate);
        } else {
            finalize(winIdx);
        }
    }
    requestAnimationFrame(animate);
}

function finalize(winIdx) {
    if (bgm) { bgm.pause(); bgm = null; }
    
    // ãƒ•ã‚§ã‚¤ãƒ³ãƒˆ
    if (currentEvent === 5) {
        currentEvent = null;
        setTimeout(() => startSpin(), 1000);
        return;
    }

    let winItem = items[winIdx];
    if (currentEvent === 10) winItem = "â–¯â–¯â–¯â–¯"; // æ–‡å­—åŒ–ã‘

    document.getElementById('resText').innerText = winItem;
    
    // å±¥æ­´è¿½åŠ 
    hist.unshift(winItem);
    if (hist.length > 10) hist.pop();
    renderHist();

    // èƒŒæ™¯è‰²
    const winCol = COLORS[winIdx % COLORS.length];
    document.body.style.background = `radial-gradient(circle, ${winCol} 0%, #ffffff 100%)`;

    // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
    if (!isMuted) {
        const winSnd = new Audio("https://soundeffect-lab.info/sound/anime/mp3/trumpet-fanfare1.mp3");
        winSnd.volume = globalVol; winSnd.play().catch(()=>{});
    }

    // æ¼”å‡ºãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥
    if (currentEvent === 8) document.body.classList.add('c-dark'); // è‰²åè»¢
    if (currentEvent === 4) document.getElementById('rWrap').classList.add('c-fall'); // é‡åŠ›
    if (currentEvent === 13) { // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
        const f = document.createElement('div'); f.className='flash-white'; document.body.appendChild(f);
        setTimeout(()=>f.remove(), 2000);
    }
    if (currentEvent === 24) { // å¼·åˆ¶ã‚„ã‚Šç›´ã—
        setTimeout(() => { hardReset(); }, 1000);
    }

    spinning = false;
    document.getElementById('spinBtn').disabled = false;
}

function resetStyles() {
    const r = document.getElementById('rWrap');
    r.className = "r-wrap"; r.style.filter = "";
    document.body.classList.remove('c-dark');
    document.getElementById('fakeAd').style.display = 'none';
}

function renderHist() {
    const u = document.getElementById('histUl'); u.innerHTML = "";
    hist.forEach(h => { const li = document.createElement('li'); li.innerText = h; u.appendChild(li); });
}

// --- èƒŒæ™¯å¹¾ä½•å­¦æ¨¡æ§˜ ---
let shapes = [];
function initBg() {
    const c = document.getElementById('bgCanvas'), ctx = c.getContext('2d');
    c.width = window.innerWidth; c.height = window.innerHeight;
    for(let i=0; i<30; i++) shapes.push({
        x: Math.random()*c.width, y: Math.random()*c.height,
        s: Math.random()*30+10, sp: Math.random()*1+0.5,
        t: Math.floor(Math.random()*3), col: COLORS[Math.floor(Math.random()*COLORS.length)]
    });
    function draw() {
        ctx.clearRect(0,0,c.width,c.height); ctx.globalAlpha = 0.4;
        shapes.forEach(p => {
            p.y += p.sp; if(p.y > c.height) p.y = -20;
            ctx.fillStyle = p.col; ctx.beginPath();
            if(p.t===0) ctx.arc(p.x, p.y, p.s/2, 0, Math.PI*2);
            else if(p.t===1) ctx.fillRect(p.x, p.y, p.s, p.s);
            else { ctx.moveTo(p.x, p.y); ctx.lineTo(p.x+p.s, p.y); ctx.lineTo(p.x+p.s/2, p.y-p.s); ctx.closePath(); }
            ctx.fill();
        });
        requestAnimationFrame(draw);
    }
    draw();
}

// --- URLä¿å­˜æ©Ÿèƒ½ (LZStringåœ§ç¸®) ---
function copyUrl() {
    const data = JSON.stringify({t: tabs, c: curTabIdx});
    const compressed = LZString.compressToEncodedURIComponent(data);
    const url = window.location.origin + window.location.pathname + "#z" + compressed;
    navigator.clipboard.writeText(url).then(() => {
        alert("ğŸ”— ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®è¨­å®šã‚’URLã¨ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nã“ã®ãƒªãƒ³ã‚¯ã‚’é–‹ãã¨ä»Šã®çŠ¶æ…‹ã‚’å¾©å…ƒã§ãã¾ã™ã€‚");
    });
}
function loadUrl() {
    const h = window.location.hash.slice(1);
    if (!h) return;
    try {
        const dec = h.startsWith('z') ? LZString.decompressFromEncodedURIComponent(h.slice(1)) : decodeURIComponent(atob(h));
        const d = JSON.parse(dec); tabs = d.t; curTabIdx = d.c;
    } catch(e) {}
}

// å«ŒãŒã‚‰ã›ç”¨é–¢æ•°
let mCount=0;
function nextM() {
    mCount++;
    const msgs = ["æœ¬å½“ã«å›ã—ã¾ã™ã‹ï¼Ÿ", "å¾Œæ‚”ã—ã¾ã›ã‚“ã‹ï¼Ÿ", "é‹å‘½ã‚’å—ã‘å…¥ã‚Œã¾ã™ã‹ï¼Ÿ", "æº–å‚™ã¯ã„ã„ã§ã™ã‹ï¼Ÿ", "ã„ãã¾ã™ã‚ˆï¼Ÿ"];
    if(mCount < 5) { document.getElementById('mMsg').innerText = msgs[mCount % msgs.length]; }
    else { document.getElementById('modalHell').style.display='none'; mCount=0; startSpin(); }
}
</script>
</body>
</html>
