<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç©¶æ¥µã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</title>
<style>
  :root {
    --bg-white: #ffffff;
    --vivid-blue: #4ECDC4;
    --vivid-red: #FF6B6B;
    --active-teal: #B2DFDB;
    --pastel-colors: ["#FFB3BA", "#FFDFBA", "#FFFFBA", "#BAFFC9", "#BAE1FF", "#E2F0CB"];
  }

  body {
    margin: 0;
    padding: 0;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    background-color: var(--bg-white);
    overflow: hidden;
    height: 100vh;
    display: flex;
    justify-content: center;
  }

  /* èƒŒæ™¯ï¼šå¹¾ä½•å­¦æ¨¡æ§˜ */
  #geo-canvas {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1;
    pointer-events: none;
    opacity: 0.5;
  }

  #main-layout {
    display: flex;
    width: 95vw;
    height: 95vh;
    max-width: 1400px;
    align-items: stretch;
    padding: 20px 0;
  }

  /* --- å·¦å´ï¼šéŸ³é‡ãƒ»ã‚¿ãƒ–ãƒ»URL --- */
  #left-panel {
    width: 25%;
    display: flex;
    flex-direction: row;
    gap: 15px;
  }

  /* éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆç¸¦ï¼‰ */
  #vol-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 20px;
    border: 1px solid #eee;
    height: fit-content;
  }
  input[type="range"] {
    writing-mode: bt-lr;
    -webkit-appearance: slider-vertical;
    width: 12px; height: 180px;
    accent-color: var(--vivid-blue);
  }

  /* ã‚¿ãƒ–ãƒªã‚¹ãƒˆ */
  #tab-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .tab-item {
    padding: 15px;
    background: #fff;
    border: 2px solid #ddd;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    text-align: center;
    transition: 0.3s;
  }
  .tab-item.active {
    background: var(--active-teal);
    border-color: var(--vivid-blue);
    border-radius: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }

  /* URLã‚¨ãƒªã‚¢ï¼ˆå·¦ä¸‹ï¼‰ */
  #url-area {
    margin-top: auto;
    background: #f0f0f0;
    padding: 10px;
    border-radius: 10px;
    font-size: 11px;
  }

  /* --- ä¸­å¤®ï¼šãƒ¡ã‚¤ãƒ³ï¼ˆã“ã“ãŒé‡è¦ï¼‰ --- */
  #center-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    padding: 0 20px;
  }

  /* 1. è¨˜å…¥ã‚¹ãƒšãƒ¼ã‚¹ */
  #input-box {
    width: 90%;
    height: 80px;
    border-radius: 15px;
    padding: 10px;
    border: 2px solid #eee;
    font-size: 16px;
    font-family: inherit;
    resize: none;
    margin-bottom: 10px;
    outline: none;
  }

  /* 2. çµæœå†…å®¹ */
  #result-text {
    font-size: 56px;
    font-weight: 900;
    color: #333;
    min-height: 80px;
    text-decoration: underline 8px var(--vivid-red);
    text-underline-offset: 12px;
    margin-bottom: 20px;
    text-align: center;
  }

  /* 3 & 4. åˆ¤å®šâ–¼ã¨å††ç›¤ */
  #wheel-container {
    position: relative;
    cursor: pointer;
  }
  #indicator-top {
    position: absolute;
    top: -10px; /* å††ç›¤ã«è‹¥å¹²è¢«ã‚‹ */
    left: 50%;
    transform: translateX(-50%);
    width: 0; height: 0;
    border-left: 25px solid transparent;
    border-right: 25px solid transparent;
    border-top: 35px solid var(--vivid-red);
    z-index: 30;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1));
  }
  #start-guide {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 32px;
    font-weight: bold;
    color: rgba(0,0,0,0.1);
    pointer-events: none;
    background: rgba(255,255,255,0.5);
    padding: 10px 20px;
    border-radius: 40px;
  }

  canvas#wheel {
    border-radius: 50%;
    background: transparent;
  }

  /* --- å³å´ï¼šå±¥æ­´ --- */
  #right-panel {
    width: 25%;
    display: flex;
    flex-direction: column;
  }
  #history-container {
    flex: 1;
    border: 4px solid var(--vivid-red);
    border-radius: 30px;
    background: #fff;
    padding: 20px;
    overflow-y: auto;
  }
  #history-list {
    list-style: none;
    padding: 0;
    font-size: 26px;
    font-weight: bold;
  }
  #history-list li {
    padding: 12px 0;
    border-bottom: 1px dashed #ffdada;
  }

  /* æ¼”å‡ºç”¨ */
  #effect-canvas {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    z-index: 20;
  }

  .btn-vivid {
    background: var(--vivid-blue);
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
  }
</style>
</head>
<body>

<canvas id="geo-canvas"></canvas>

<div id="main-layout">
  <div id="left-panel">
    <div id="vol-container">
      <span style="font-weight:bold; color:#666;">å¤§</span>
      <input type="range" id="vol-slider" min="0" max="1" step="0.1" value="0.5">
      <span style="font-weight:bold; color:#666;">å°</span>
      <label style="font-size:12px; margin-top:10px;"><input type="checkbox" id="sound-toggle" checked>éŸ³</label>
    </div>
    <div id="tab-area">
      <div id="tab-list"></div>
      <div id="url-area">
        <button class="btn-vivid" onclick="generateURL()">ğŸ”— URLç™ºè¡Œ</button>
        <div id="url-box" style="display:none; margin-top:8px;">
          <input type="text" id="url-input" readonly style="width:70%; font-size:10px;">
          <button class="btn-vivid" style="padding:4px 8px;" onclick="copyURL()">ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>
    </div>
  </div>

  <div id="center-panel">
    <textarea id="input-box" placeholder="é …ç›®ã‚’æ”¹è¡Œã§å…¥åŠ›..."></textarea>
    <div id="result-text"></div>
    <div id="wheel-container" onclick="handleSpin()">
      <div id="indicator-top"></div>
      <canvas id="wheel" width="550" height="550"></canvas>
      <div id="start-guide">æŠ½é¸é–‹å§‹</div>
    </div>
    <canvas id="effect-canvas"></canvas>
  </div>

  <div id="right-panel">
    <div id="history-container">
      <div style="text-align:center; color:var(--vivid-red); font-weight:900; margin-bottom:15px;">å±¥æ­´</div>
      <ul id="history-list"></ul>
    </div>
  </div>
</div>

<script>
  let state = {
    tabs: [{ name: "ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ1", items: ["A", "B", "C"] }],
    activeIndex: 0,
    history: [],
    angle: 0,
    spinning: false,
    volume: 0.5
  };

  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  const effCanvas = document.getElementById('effect-canvas');
  const effCtx = effCanvas.getContext('2d');
  const pastelColors = ["#FFB3BA", "#FFDFBA", "#FFFFBA", "#BAFFC9", "#BAE1FF", "#E2F0CB", "#FFDAC1", "#E0BBE4"];

  function init() {
    effCanvas.width = effCanvas.parentElement.clientWidth;
    effCanvas.height = effCanvas.parentElement.clientHeight;
    
    // URLã‹ã‚‰ã®å¾©å…ƒ
    const params = new URLSearchParams(window.location.search);
    if(params.has('d')) {
      try { state.tabs = JSON.parse(decodeURIComponent(atob(params.get('d')))); } catch(e){}
    }
    
    renderTabs();
    loadTab();
    drawBG();
  }

  function loadTab() {
    document.getElementById('input-box').value = state.tabs[state.activeIndex].items.join('\n');
    drawWheel();
  }

  function drawWheel(hitIdx = -1) {
    const items = state.tabs[state.activeIndex].items;
    const cx = 275, cy = 275, r = 265;
    ctx.clearRect(0,0,550,550);
    if(items.length === 0) return;

    const step = (Math.PI * 2) / items.length;
    items.forEach((txt, i) => {
      const s = state.angle + i * step;
      const e = s + step;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, r, s, e);
      // å½“ãŸã£ãŸã¨ã“ã‚ã ã‘ãƒ“ãƒ“ãƒƒãƒˆãªãƒ”ãƒ³ã‚¯ã«
      ctx.fillStyle = (i === hitIdx) ? "#FF007C" : pastelColors[i % pastelColors.length];
      ctx.fill();
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 4;
      ctx.stroke();

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(s + step/2);
      ctx.fillStyle = "#333";
      ctx.font = "bold 24px sans-serif";
      ctx.textAlign = "right";
      ctx.fillText(txt.slice(0,10), r - 40, 8);
      ctx.restore();
    });

    // ã‚»ãƒ³ã‚¿ãƒ¼ã‚µãƒ¼ã‚¯ãƒ«
    ctx.beginPath();
    ctx.arc(cx, cy, 30, 0, Math.PI*2);
    ctx.fillStyle = "#fff";
    ctx.fill();
  }

  // --- ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª (ãƒ†ã‚£ãƒ³ãƒ‘ãƒ‹ãƒ­ãƒ¼ãƒ« & ã©ã‚“ã©ã‚“ã±ãµã±ãµ) ---
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playSE(type) {
    if(!document.getElementById('sound-toggle').checked) return;
    if(audioCtx.state === 'suspended') audioCtx.resume();

    const gain = audioCtx.createGain();
    gain.connect(audioCtx.destination);
    gain.gain.setValueAtTime(state.volume, audioCtx.currentTime);

    if(type === 'roll') {
      const osc = audioCtx.createOscillator();
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(70, audioCtx.currentTime);
      osc.connect(gain);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
      osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    } else {
      // ãƒ‰ãƒ³ãƒ‰ãƒ³ãƒ‘ãƒ•ãƒ‘ãƒ•å†ç¾
      [523, 659, 783, 1046].forEach((f, i) => {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'triangle';
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.setValueAtTime(f, audioCtx.currentTime + i * 0.1);
        g.gain.setValueAtTime(state.volume, audioCtx.currentTime + i * 0.1);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.1 + 0.5);
        o.start(audioCtx.currentTime + i * 0.1); o.stop(audioCtx.currentTime + i * 0.1 + 0.6);
      });
    }
  }

  function handleSpin() {
    if(state.spinning || state.tabs[state.activeIndex].items.length < 2) return;
    state.spinning = true;
    document.getElementById('start-guide').style.display = 'none';
    document.getElementById('result-text').textContent = '';
    
    let speed = Math.random() * 0.5 + 0.5;
    function frame() {
      state.angle += speed;
      speed *= 0.99;
      playSE('roll');
      if(speed < 0.003) {
        state.spinning = false;
        finalize();
        return;
      }
      drawWheel();
      requestAnimationFrame(frame);
    }
    frame();
  }

  function finalize() {
    const items = state.tabs[state.activeIndex].items;
    const step = (Math.PI * 2) / items.length;
    // çœŸä¸Š(1.5*PI)ã«ã‚ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é€†ç®—
    const pointer = (Math.PI * 1.5 - state.angle % (Math.PI * 2) + Math.PI * 2) % (Math.PI * 2);
    const hit = Math.floor(pointer / step);
    
    drawWheel(hit);
    const winner = items[hit];
    document.getElementById('result-text').textContent = winner;
    playSE('win');
    addHistory(winner);
    triggerExplosion();
    setTimeout(() => { document.getElementById('start-guide').style.display = 'block'; }, 1500);
  }

  function addHistory(txt) {
    state.history.unshift(txt);
    if(state.history.length > 20) state.history.pop();
    document.getElementById('history-list').innerHTML = state.history.map(h => `<li>${h}</li>`).join('');
  }

  function triggerExplosion() {
    const particles = [];
    for(let i=0; i<50; i++) {
      particles.push({
        x: effCanvas.width/2, y: 150, // çµæœãƒ†ã‚­ã‚¹ãƒˆä»˜è¿‘ã‹ã‚‰
        vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20,
        s: Math.random()*15+5, c: pastelColors[Math.floor(Math.random()*pastelColors.length)],
        t: Math.random() > 0.5 ? 'rect' : 'tri', l: 1.0
      });
    }
    function drawParticles() {
      effCtx.clearRect(0,0,effCanvas.width,effCanvas.height);
      let alive = false;
      particles.forEach(p => {
        if(p.l > 0) {
          alive = true; p.x += p.vx; p.y += p.vy; p.vy += 0.4; p.l -= 0.015;
          effCtx.globalAlpha = p.l; effCtx.fillStyle = p.c;
          effCtx.beginPath();
          if(p.t==='rect') effCtx.fillRect(p.x, p.y, p.s, p.s);
          else { effCtx.moveTo(p.x,p.y); effCtx.lineTo(p.x+p.s,p.y+p.s); effCtx.lineTo(p.x-p.s,p.y+p.s); effCtx.fill(); }
        }
      });
      if(alive) requestAnimationFrame(drawParticles);
    }
    drawParticles();
  }

  function renderTabs() {
    const list = document.getElementById('tab-list');
    list.innerHTML = state.tabs.map((t, i) => `
      <div class="tab-item ${i === state.activeIndex ? 'active' : ''}" onclick="selectTab(${i})">${t.name}</div>
    `).join('') + (state.tabs.length < 5 ? `<div class="tab-item" style="color:#aaa" onclick="addTab()">+ è¿½åŠ </div>` : '');
  }
  function selectTab(i) { state.activeIndex = i; renderTabs(); loadTab(); }
  function addTab() { 
    const n = prompt("åå‰ã¯ï¼Ÿ", "ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ" + (state.tabs.length+1));
    if(n){ state.tabs.push({name:n, items:[]}); state.activeIndex = state.tabs.length-1; renderTabs(); loadTab(); }
  }

  document.getElementById('input-box').addEventListener('input', (e) => {
    state.tabs[state.activeIndex].items = e.target.value.split('\n').filter(v => v.trim() !== '');
    drawWheel();
  });
  document.getElementById('vol-slider').addEventListener('input', (e) => state.volume = e.target.value);

  function generateURL() {
    const d = btoa(encodeURIComponent(JSON.stringify(state.tabs)));
    const url = window.location.origin + window.location.pathname + "?d=" + d;
    document.getElementById('url-input').value = url;
    document.getElementById('url-box').style.display = 'block';
  }
  function copyURL() { navigator.clipboard.writeText(document.getElementById('url-input').value); alert("ã‚³ãƒ”ãƒ¼æˆåŠŸï¼"); }

  function drawBG() {
    const bg = document.getElementById('geo-canvas');
    const bctx = bg.getContext('2d');
    bg.width = window.innerWidth; bg.height = window.innerHeight;
    for(let i=0; i<25; i++) {
      bctx.fillStyle = pastelColors[i % pastelColors.length];
      bctx.globalAlpha = 0.2;
      bctx.beginPath();
      if(i%2===0) bctx.fillRect(Math.random()*bg.width, Math.random()*bg.height, 40, 40);
      else {
        bctx.moveTo(Math.random()*bg.width, Math.random()*bg.height);
        bctx.lineTo(Math.random()*bg.width, Math.random()*bg.height);
        bctx.lineTo(Math.random()*bg.width, Math.random()*bg.height);
        bctx.fill();
      }
    }
  }

  init();
</script>
</body>
</html>
