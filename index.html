<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ルレット</title>
<style>
:root {
  --bg: #ffffff;
  --border: #ffffff;
  --tab-green: #9be3c7;
  --tab-active: #cceee6;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Rounded Mplus 1c", system-ui, sans-serif;
  background: var(--bg);
  display: flex;
  justify-content: center;
  align-items: flex-start;
  height: 100vh;
}
.app {
  display: grid;
  grid-template-columns: 1fr 2fr 1fr;
  gap: 24px;
  width: 100%;
  max-width: 1600px;
  padding: 24px;
}
/* 左：タブ */
.tabs {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.tab {
  border: 2px solid var(--tab-green);
  padding: 14px;
  cursor: pointer;
}
.tab.active {
  background: var(--tab-active);
  border-radius: 14px;
}
/* 音量 */
.volume {
  margin-top: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.volume input {
  writing-mode: bt-lr;
  -webkit-appearance: slider-vertical;
  height: 140px;
}
/* 中央 */
.center {
  display: flex;
  flex-direction: column;
  align-items: center;
}
canvas {
  width: 420px;
  height: 420px;
  cursor: pointer;
}
.hit {
  font-size: 40px;
  font-weight: 700;
  margin-top: 16px;
  text-decoration: underline;
}
/* 右：履歴 */
.history {
  border: 2px solid red;
  border-radius: 12px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 420px;
  overflow-y: auto;
}
.history div { font-size: 22px; }
/* 下 */
.bottom {
  position: fixed;
  left: 24px;
  bottom: 24px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
</style>
</head>
<body>
<div class="app">
  <div class="tabs">
    <div class="tab active">ルーレット</div>
    <div class="volume">
      <span>音量</span>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.7">
    </div>
  </div>
  <div class="center">
    <canvas id="wheel" width="420" height="420"></canvas>
    <div class="hit" id="hit">—</div>
  </div>
  <div class="history" id="history"></div>
</div>
<div class="bottom">
  <button id="gen">URL生成</button>
  <div id="url"></div>
</div>
<script>
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const hitEl = document.getElementById('hit');
const historyEl = document.getElementById('history');

const items = ["A","B","C"];
let angle = 0;
let spinning = false;

const timpani = new Audio('https://soundeffect-lab.info/sound/battle/mp3/timpani-roll.mp3');
timpani.loop = true;
const pafu = new Audio('https://soundeffect-lab.info/sound/various/mp3/dondonpafupafu.mp3');

const vol = document.getElementById('vol');
vol.oninput = ()=>{ timpani.volume = pafu.volume = vol.value; }

function draw(hitIndex=null){
  ctx.clearRect(0,0,420,420);
  const r = 210;
  const cx = 210;
  const cy = 210;
  const step = Math.PI*2/items.length;
  items.forEach((t,i)=>{
    const s = i*step + angle;
    const e = s + step;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,s,e);
    ctx.closePath();
    ctx.fillStyle = i===hitIndex ? "#ffb3b3" : "#cceeff";
    ctx.fill();
    ctx.strokeStyle = "#fff";
    ctx.stroke();

    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(s + step/2);
    ctx.fillStyle = "#333";
    ctx.textAlign="right";
    ctx.font = "16px sans-serif";
    ctx.fillText(t,r-10,5);
    ctx.restore();
  });
  // ▼ 下マーク
  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.moveTo(cx-12,cy+r+8);
  ctx.lineTo(cx+12,cy+r+8);
  ctx.lineTo(cx,cy+r+28);
  ctx.fill();

  // 抽選開始文字
  ctx.fillStyle='rgba(0,0,0,0.2)';
  ctx.font='24px sans-serif';
  ctx.textAlign='center';
  ctx.fillText('抽選開始',cx,cy);
}

function getHitIndex(){
  const step = Math.PI*2/items.length;
  const pointer = (3*Math.PI/2 - angle + Math.PI*2) % (Math.PI*2);
  return Math.floor(pointer/step);
}

function spin(){
  if(spinning||items.length===0) return;
  spinning = true;
  timpani.currentTime=0;
  timpani.play();
  let speed = Math.random()*0.3 + 0.25;
  hitEl.textContent="抽選中…";

  const loop = ()=>{
    angle += speed;
    speed *= 0.985;
    if(speed<0.002){
      spinning=false;
      timpani.pause();
      pafu.play();
      const idx = getHitIndex();
      hitEl.textContent = items[idx];
      const div = document.createElement('div');
      div.textContent = items[idx];
      historyEl.prepend(div);
      while(historyEl.children.length>20) historyEl.removeChild(historyEl.lastChild);
      draw(idx);
      setTimeout(()=>draw(),400);
      return;
    }
    draw();
    requestAnimationFrame(loop);
  };
  loop();
}

canvas.onclick = spin;
draw();
</script>
</body>
</html>
