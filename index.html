<script>
const canvas = document.getElementById("roulette");
const ctx = canvas.getContext("2d");

let items = ["A", "B", "C"];
let angle = 0;
let spinning = false;
let velocity = 0;

function drawRoulette(highlightIndex = null) {
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const r = canvas.width / 2 - 10;
  const step = (Math.PI * 2) / items.length;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  items.forEach((text, i) => {
    const start = angle + step * i;
    const end = start + step;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, start, end);
    ctx.closePath();

    ctx.fillStyle =
      i === highlightIndex
        ? "rgb(255,190,190)" // 当たり（少し濃いパステル）
        : `hsl(${(i * 360) / items.length}, 70%, 85%)`;

    ctx.fill();
    ctx.strokeStyle = "#fff";
    ctx.stroke();

    // 文字
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(start + step / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#333";
    ctx.font = "16px sans-serif";
    ctx.fillText(text, r - 10, 5);
    ctx.restore();
  });

  // ▼（下の判定マーカー）
  ctx.fillStyle = "#000";
  ctx.beginPath();
  ctx.moveTo(cx - 10, cy + r + 5);
  ctx.lineTo(cx + 10, cy + r + 5);
  ctx.lineTo(cx, cy + r + 25);
  ctx.closePath();
  ctx.fill();
}

function getHitIndex() {
  const step = (Math.PI * 2) / items.length;

  // ▼は「下（6時）」＝ 90度（Math.PI / 2）
  let pointerAngle = (Math.PI / 2 - angle) % (Math.PI * 2);
  if (pointerAngle < 0) pointerAngle += Math.PI * 2;

  return Math.floor(pointerAngle / step);
}

function spin() {
  if (spinning) return;
  spinning = true;
  velocity = Math.random() * 0.3 + 0.35;

  function animate() {
    angle += velocity;
    velocity *= 0.985;

    if (velocity < 0.002) {
      spinning = false;
      const hit = getHitIndex();
      drawRoulette(hit);
      return;
    }

    drawRoulette();
    requestAnimationFrame(animate);
  }

  animate();
}

canvas.addEventListener("click", spin);

// 初期描画
drawRoulette();
</script>
