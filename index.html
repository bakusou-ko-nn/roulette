<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÅãÂëΩ„ÅÆ„É´„Éº„É¨„ÉÉ„Éà</title>
    <style>
        /* --- „Éá„Ç∂„Ç§„É≥Â§âÊï∞ („Éë„Çπ„ÉÜ„É´&„ÇÜ„Å£„Åü„Çä) --- */
        :root {
            --bg-color: #ffffff;
            --text-color: #444;
            /* ÂéüËâ≤30%Á®ãÂ∫¶„ÅÆ„Éë„Çπ„ÉÜ„É´„Ç´„É©„Éº */
            --p-red: #ffb3ba;
            --p-yellow: #ffffba;
            --p-orange: #ffdfba;
            --p-blue: #bae1ff;
            --p-purple: #e2baff;
            --p-green: #baffc9;
            --p-gray: #e0e0e0;
            
            --mint-active: #98ff98;
            --border-deep: #555;
            --border-light: #ccc;
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 1s ease;
        }

        /* ËÉåÊôØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî® */
        #bgCanvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà (3„Ç´„É©„É†) */
        .container {
            display: grid;
            grid-template-columns: 260px 1fr 260px;
            gap: 40px;
            width: 95%;
            max-width: 1600px;
            height: 90vh;
            position: relative;
            z-index: 1;
        }

        /* --- Â∑¶„Çµ„Ç§„Éâ (Êìç‰ΩúÁ≥ª) --- */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            justify-content: center;
        }

        /* Èü≥Èáè„Ç®„É™„Ç¢ */
        .audio-control {
            border: 1px solid var(--border-light);
            padding: 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        .volume-game-box {
            position: relative;
            height: 80px;
            border-bottom: 4px solid #666;
            margin-bottom: 10px;
            overflow: hidden;
            background: #fafafa;
            border-radius: 4px;
        }
        #volBall {
            width: 18px; height: 18px;
            background: #ff6b6b;
            border-radius: 50%;
            position: absolute;
            top: 0; left: 50%;
            display: none;
        }
        .vol-scale {
            height: 6px;
            width: 100%;
            background: linear-gradient(to right, #bae1ff, #ffb3ba);
            border-radius: 3px;
        }
        .audio-btns {
            display: flex; gap: 5px; justify-content: center; margin-top: 8px;
        }

        /* „Çø„Éñ„Ç®„É™„Ç¢ */
        .tabs {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .tab-item {
            padding: 12px 15px;
            border: 1px solid #2e8b57; /* Ê∑±Á∑ë */
            background: white;
            cursor: pointer;
            border-radius: 6px;
            transition: 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tab-item.active {
            background-color: var(--mint-active);
            border-radius: 15px;
            border-color: var(--mint-active);
            font-weight: bold;
        }
        .tab-edit {
            font-size: 11px;
            color: #666;
            text-decoration: underline;
            cursor: pointer;
        }

        /* URL„Éª„É™„Çª„ÉÉ„Éà */
        .system-btns {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        button {
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.1s;
            font-weight: bold;
        }
        button:active { transform: scale(0.98); }
        .btn-url { background: var(--p-blue); color: #444; }
        .btn-reset { background: var(--p-red); color: #444; }
        .btn-undo { background: var(--p-yellow); color: #444; font-size: 12px; }

        /* --- ‰∏≠Â§Æ („É´„Éº„É¨„ÉÉ„Éà) --- */
        .center-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .result-box {
            font-size: 36px;
            font-weight: bold;
            height: 50px;
            color: #333;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0 #fff;
            z-index: 10;
        }

        .roulette-container {
            position: relative;
            margin-bottom: 20px;
            transition: transform 0.5s; /* „Ç´„Ç™„ÇπÊºîÂá∫Áî® */
        }
        .needle {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            color: #333;
            z-index: 5;
            text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        canvas#rouletteCanvas {
            border-radius: 50%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            background: white;
        }

        #spinBtn {
            width: 220px;
            height: 60px;
            font-size: 24px;
            background: var(--p-green);
            color: #333;
            box-shadow: 0 4px 0 #88cc88;
            margin-bottom: 15px;
        }
        #spinBtn:active { box-shadow: 0 0 0; transform: translateY(4px); }

        textarea#inputs {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 2px solid var(--p-gray);
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            outline: none;
        }

        /* --- Âè≥„Çµ„Ç§„Éâ (Â±•Ê≠¥) --- */
        .right-panel {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .history-card {
            border: 2px solid #ff6b6b;
            border-radius: 20px;
            padding: 20px;
            height: 70%;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .history-head {
            text-align: center;
            color: #ff6b6b;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 2px dashed #ffb3ba;
            padding-bottom: 5px;
        }
        .history-list {
            list-style: none;
            padding: 0; margin: 0;
            overflow-y: auto;
            flex: 1;
        }
        .history-list li {
            padding: 10px 5px;
            border-bottom: 1px solid #eee;
            font-size: 15px;
            color: #555;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }

        /* --- „Ç´„Ç™„ÇπÊºîÂá∫Áî®„ÇØ„É©„Çπ --- */
        .chaos-dark { filter: invert(1) hue-rotate(180deg); background: #000 !important; }
        .chaos-pixel { image-rendering: pixelated; transform: scale(0.05) rotate(720deg); transition: 3s ease-in; }
        .chaos-fall { transform: translateY(120vh) rotate(15deg); transition: transform 1.5s cubic-bezier(0.5, 0, 1, 1); }
        .chaos-invisible { opacity: 0.05; }
        .chaos-giant { transform: scale(1.5); }
        
        /* ÂòòÂ∫ÉÂëä */
        #fakeAd {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 320px; height: 250px; background: #fff; border: 4px solid red;
            z-index: 9999; display: none; flex-direction: column;
            justify-content: center; align-items: center;
            box-shadow: 10px 10px 20px rgba(0,0,0,0.5);
            font-weight: bold; font-size: 20px; color: red;
        }
        #fakeAd span { font-size: 12px; position: absolute; top: 0; right: 0; padding: 5px; cursor: pointer; background: #eee; border: 1px solid #333;}
        
        /* „É¢„Éº„ÉÄ„É´Âú∞ÁçÑ */
        #modalHell {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 30px; border-radius: 10px; text-align: center; }

    </style>
</head>
<body>

    <canvas id="bgCanvas"></canvas>

    <div class="container" id="mainApp">
        <div class="left-panel">
            <div class="audio-control">
                <div class="volume-game-box" id="volBox">
                    <div id="volBall"></div>
                </div>
                <div class="vol-scale"></div>
                <div class="audio-btns">
                    <button onclick="dropVolume()" style="background:#eee;">üîä Èü≥ÈáèÊäΩÈÅ∏</button>
                    <button onclick="toggleMute()" style="background:#eee;">üîá MUTE</button>
                </div>
            </div>

            <div class="tabs" id="tabList">
                </div>

            <div class="system-btns">
                <button class="btn-url" onclick="genUrl()">üîó URLÁô∫Ë°å & „Ç≥„Éî„Éº</button>
                <button class="btn-reset" onclick="resetAll()">‚ö†Ô∏è Âº∑Âà∂„É™„Çª„ÉÉ„Éà</button>
                <button class="btn-undo" onclick="undo()">‚Ü©Ô∏è Undo</button>
            </div>
        </div>

        <div class="center-panel">
            <div class="result-box" id="resultText">READY</div>
            
            <div class="roulette-container" id="rContainer">
                <div class="needle" id="needle">‚ñº</div>
                <canvas id="rouletteCanvas" width="500" height="500"></canvas>
            </div>

            <button id="spinBtn" onclick="startSpin()">START</button>
            <textarea id="inputs" placeholder="È†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ&#13;&#10;ÊîπË°å„ÅßÂå∫Âàá„Çâ„Çå„Åæ„Åô&#13;&#10;(ÊúÄÂ§ß500ÂçòË™û)"></textarea>
        </div>

        <div class="right-panel">
            <div class="history-card">
                <div class="history-head">HISTORY (Latest 10)</div>
                <ul class="history-list" id="historyUl"></ul>
            </div>
        </div>
    </div>

    <div id="fakeAd">
        <span onclick="this.parentElement.style.display='none'">√ó</span>
        <p>üö® ÂΩìÈÅ∏Á¢∫Áéá 99% UP!? üö®</p>
        <p style="font-size: 14px; color: black;">‰ªä„Åô„Åê„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁôªÈå≤ÔºÅ</p>
        <button style="margin-top:20px; background:red; color:white;">Ë©≥Á¥∞„ÇíË¶ã„Çã</button>
    </div>

    <div id="modalHell">
        <div class="modal-content">
            <p id="modalMsg">Êú¨ÂΩì„Å´Âõû„Åó„Åæ„Åô„ÅãÔºü</p>
            <button onclick="nextModal()">„ÅØ„ÅÑ</button>
        </div>
    </div>

<script>
/**
 * ==========================================
 * CORE LOGIC & CONFIG
 * ==========================================
 */
const COLORS = ['#ffb3ba', '#ffffba', '#ffdfba', '#bae1ff', '#e2baff', '#baffc9', '#e0e0e0'];
const MAX_ITEMS = 500;

// State
let items = ["„É©„Éº„É°„É≥", "„Ç´„É¨„Éº", "„ÅÜ„Å©„Çì", "„Éë„Çπ„Çø"];
let tabs = [
    { name: "„É©„É≥„ÉÅ", content: "„É©„Éº„É°„É≥\n„Ç´„É¨„Éº\n„ÅÜ„Å©„Çì\n„Éë„Çπ„Çø" },
    { name: "Êú™Ë®≠ÂÆö", content: "" },
    { name: "Êú™Ë®≠ÂÆö", content: "" },
    { name: "Êú™Ë®≠ÂÆö", content: "" },
    { name: "Êú™Ë®≠ÂÆö", content: "" }
];
let currentTab = 0;
let historyLog = [];
let prevContent = ""; // UndoÁî®
let globalVol = 0.5;
let isMuted = false;
let isSpinning = false;

// Audio
let bgmSource = null; // Tympani loop

// Chaos
let chaosActive = false;
let chaosType = null;
let clickSpamCount = 0;

window.onload = () => {
    loadHash();
    renderTabs();
    updateInputFromTab();
    drawBackground();
    animBackground();

    // Input Listener
    document.getElementById('inputs').addEventListener('input', (e) => {
        tabs[currentTab].content = e.target.value;
        parseItems();
        drawRoulette();
    });
};

/**
 * ==========================================
 * ROULETTE DRAWING
 * ==========================================
 */
function parseItems() {
    const raw = tabs[currentTab].content;
    items = raw.split('\n').filter(x => x.trim() !== "").slice(0, MAX_ITEMS);
}

function drawRoulette(rotationOffset = 0) {
    const cvs = document.getElementById('rouletteCanvas');
    const ctx = cvs.getContext('2d');
    const r = cvs.width / 2;
    const total = items.length;

    ctx.clearRect(0,0,cvs.width,cvs.height);

    // Outer Circle
    ctx.beginPath();
    ctx.arc(r, r, r - 5, 0, Math.PI*2);
    ctx.fillStyle = "#fff";
    ctx.fill();
    ctx.lineWidth = 8;
    ctx.strokeStyle = "#aaa";
    ctx.stroke();

    if (total === 0) return;

    const arc = (Math.PI * 2) / total;

    for(let i=0; i<total; i++) {
        const angle = rotationOffset + (i * arc);
        ctx.beginPath();
        ctx.moveTo(r, r);
        ctx.arc(r, r, r - 10, angle, angle + arc);
        ctx.fillStyle = COLORS[i % COLORS.length];
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#fff";
        ctx.stroke();

        // Text
        ctx.save();
        ctx.translate(r, r);
        ctx.rotate(angle + arc/2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#444";
        ctx.font = "bold 20px sans-serif";
        const text = items[i];
        // Èï∑„ÅÑÊñáÂ≠ó„ÅØÁúÅÁï•
        const dispText = text.length > 10 ? text.substring(0,9)+".." : text;
        ctx.fillText(dispText, r - 30, 6);
        ctx.restore();
    }
}

/**
 * ==========================================
 * SPIN LOGIC & CHAOS
 * ==========================================
 */
async function startSpin() {
    if (isSpinning) return;
    if (items.length === 0) { alert("È†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ"); return; }

    // State Save for Undo
    prevContent = tabs[currentTab].content;

    // Chaos Determination (20%)
    chaosActive = Math.random() < 0.2;
    chaosType = chaosActive ? pickChaos() : null;

    // Reset Chaos Styles
    resetChaosStyles();

    // Pre-Spin Harassment
    if (chaosType === 'spam') {
        if (!handleSpamClick()) return;
    }
    if (chaosType === 'modal') {
        await handleModalHell();
    }
    if (chaosType === 'fakeAd') {
        document.getElementById('fakeAd').style.display = 'flex';
    }

    isSpinning = true;
    
    // Play Start Sound
    playSound('roll');

    // Spin Animation
    if (chaosType === 'reverse') {
        spinReverse();
    } else if (chaosType === 'gravity') {
        spinNormal(() => {
            // Drop after stop
            document.getElementById('rContainer').classList.add('chaos-fall');
        });
    } else if (chaosType === 'stop_fake') {
        spinFake();
    } else {
        spinNormal();
    }
}

function spinNormal(onStopCallback = null) {
    let speed = 50;
    let angle = 0;
    let friction = 0.985;
    
    // Chaos: Invisible
    if (chaosType === 'invisible') {
        document.getElementById('rouletteCanvas').classList.add('chaos-invisible');
    }

    const loop = () => {
        speed *= friction;
        angle += speed * Math.PI / 180;
        drawRoulette(angle);

        if (speed < 0.1) {
            finishSpin(angle);
            if(onStopCallback) onStopCallback();
        } else {
            requestAnimationFrame(loop);
        }
    };
    loop();
}

function spinReverse() {
    let speed = 50;
    let angle = 0;
    let reversed = false;
    
    const loop = () => {
        if (!reversed) {
            speed *= 0.98;
            angle += speed * Math.PI/180;
            if (speed < 5) { reversed = true; speed = 60; /* ÈÄÜÂô¥Â∞Ñ */ }
        } else {
            speed *= 0.98;
            angle -= speed * Math.PI/180; // Reverse
        }
        drawRoulette(angle);

        if (reversed && speed < 0.1) {
            finishSpin(angle);
        } else {
            requestAnimationFrame(loop);
        }
    };
    loop();
}

function spinFake() {
    // Ê≠¢„Åæ„Çã„Å®Ë¶ã„Åõ„Åã„Åë„Å¶...
    let speed = 50;
    let angle = 0;
    let faked = false;

    const loop = () => {
        if (!faked && speed < 0.5) {
            faked = true;
            speed = 40; // ÂÜçÂä†ÈÄü
            // „Éï„Ç°„É≥„Éï„Ç°„Éº„É¨„Å†„ÅëÈ≥¥„Çâ„Åó„Å¶„Åø„Çã(„Éï„Çß„Ç§„É≥„Éà)
            let fakeWin = new Audio("https://soundeffect-lab.info/sound/anime/mp3/jean1.mp3");
            fakeWin.volume = globalVol;
            fakeWin.play();
        }
        speed *= 0.985;
        angle += speed * Math.PI/180;
        drawRoulette(angle);

        if (faked && speed < 0.1) {
            finishSpin(angle);
        } else {
            requestAnimationFrame(loop);
        }
    };
    loop();
}

function finishSpin(finalAngle) {
    isSpinning = false;

    // Calc Result
    // 0rad is right (3 o'clock). Needle is top (270deg / 1.5PI).
    // Effective Angle = (270 - deg) normalized
    const total = items.length;
    const arc = (Math.PI * 2) / total;
    const normAngle = finalAngle % (Math.PI * 2);
    
    // Èáù„ÅÆ‰ΩçÁΩÆ„Å´„ÅÇ„Çã„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÈÄÜÁÆó
    let index = Math.floor(((1.5 * Math.PI - normAngle + 2*Math.PI) % (2*Math.PI)) / arc);
    let winItem = items[index];

    // Chaos Logic on Finish
    if (chaosType === 'mojibake') winItem = "‚ñØ‚ñØ‚ñØ‚ñØ‚ñØ‚ñØ";
    if (chaosType === 'pixel') document.getElementById('rContainer').classList.add('chaos-pixel');
    if (chaosType === 'invert') document.body.classList.add('chaos-dark');
    if (chaosType === 'explosion') {
        document.getElementById('rContainer').innerHTML = "<h1 style='font-size:80px;color:red'>BOOM!</h1>";
    }
    
    // Display
    document.getElementById('resultText').innerText = winItem;
    
    // Change BG
    document.body.style.backgroundColor = COLORS[index % COLORS.length]; // Gradient is hard in CSS var, using simple color
    
    // Sound
    playSound('win');

    // History
    if (chaosType !== 'mojibake') {
        historyLog.unshift(winItem);
        if(historyLog.length > 10) historyLog.pop();
        renderHistory();
    }

    if (chaosType === 'reset_win') {
        setTimeout(() => { alert("„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº"); resetAll(); }, 1000);
    }
}

/**
 * ==========================================
 * SOUND MANAGER (80% „Ç∏„É£„É≥ / 20% „Åù„ÅÆ‰ªñ)
 * ==========================================
 */
function playSound(type) {
    if (isMuted) return;

    // --- 1. ÂõûËª¢‰∏≠„ÅÆ„ÉÜ„Ç£„É≥„Éë„Éã ---
    if (type === 'roll') {
        if (bgmSource) bgmSource.pause();
        bgmSource = new Audio("https://soundeffect-lab.info/sound/anime/mp3/tympani-roll1.mp3");
        bgmSource.loop = true;
        // „Ç´„Ç™„Çπ„ÅßÈü≥ÈáèÈÄÜËª¢„Å™„ÇâÁàÜÈü≥
        bgmSource.volume = (chaosType === 'loud') ? 1.0 : globalVol;
        bgmSource.play().catch(e=>{});
    } 
    
    // --- 2. ÂΩìÈÅ∏Èü≥ ---
    else if (type === 'win') {
        if (bgmSource) { bgmSource.pause(); bgmSource = null; }

        const soundJean = "https://soundeffect-lab.info/sound/anime/mp3/jean1.mp3";
        const others = [
            "https://soundeffect-lab.info/sound/anime/mp3/trumpet2.mp3",
            "https://soundeffect-lab.info/sound/anime/mp3/shine3.mp3",
            "https://soundeffect-lab.info/sound/anime/mp3/tin1.mp3"
        ];

        let targetUrl;
        // 80% Jean, 20% Others
        if (Math.random() < 0.8) {
            targetUrl = soundJean;
        } else {
            targetUrl = others[Math.floor(Math.random() * others.length)];
        }

        let audio = new Audio(targetUrl);
        audio.volume = (chaosType === 'loud') ? 1.0 : globalVol;
        audio.play().catch(e=>{});
    }
}

/**
 * ==========================================
 * CHAOS UTILS
 * ==========================================
 */
function pickChaos() {
    const list = [
        'spam', 'modal', 'fakeAd',       // UI
        'reverse', 'gravity', 'stop_fake', // Physics
        'mojibake', 'pixel', 'invert', 'explosion', 'invisible', // Visual
        'loud', 'reset_win' // System
    ];
    return list[Math.floor(Math.random() * list.length)];
}

function resetChaosStyles() {
    const rc = document.getElementById('rContainer');
    const cvs = document.getElementById('rouletteCanvas');
    rc.className = 'roulette-container';
    cvs.className = '';
    document.body.classList.remove('chaos-dark');
    document.getElementById('fakeAd').style.display = 'none';
    if(document.getElementById('pointer')) return; 
    // If exploded, restore
    if (!rc.querySelector('canvas')) {
        rc.innerHTML = `<div class="needle" id="needle">‚ñº</div><canvas id="rouletteCanvas" width="500" height="500"></canvas>`;
        drawRoulette();
    }
}

// UI Harassment Implementations
function handleSpamClick() {
    const btn = document.getElementById('spinBtn');
    if (clickSpamCount < 20) {
        clickSpamCount++;
        btn.innerText = `ÈÄ£ÊâìÔºÅ(${20 - clickSpamCount})`;
        btn.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
        return false;
    }
    clickSpamCount = 0;
    btn.innerText = "START";
    btn.style.transform = "none";
    return true;
}

function handleModalHell() {
    return new Promise(resolve => {
        let count = 0;
        const m = document.getElementById('modalHell');
        const msg = document.getElementById('modalMsg');
        m.style.display = 'flex';
        
        window.nextModal = function() {
            count++;
            const texts = ["Êú¨ÂΩì„Å´Ôºü", "ÂæåÊÇî„Åó„Å™„ÅÑÔºü", "„ÅîÈ£ØÈ£ü„Åπ„ÅüÔºü", "„Éà„Ç§„É¨Ë°å„Å£„ÅüÔºü", "Êäº„Åô„Å™„ÇàÔºü", "Êú¨ÂΩì„Å´Âõû„Åô„ÅÆÔºü", "Êàª„Çå„Å™„ÅÑ„ÇàÔºü", "„É©„Çπ„Éà„ÉÅ„É£„É≥„Çπ", "„ÅÑ„ÅÑ„Çì„Åß„Åô„Å≠Ôºü", "„Éï„Ç°„Ç§„Éä„É´„Ç¢„É≥„Çµ„ÉºÔºü"];
            if(count < 10) {
                msg.innerText = texts[count] || "Êú¨ÂΩì„Å´Ôºü";
            } else {
                m.style.display = 'none';
                resolve();
            }
        }
    });
}

/**
 * ==========================================
 * UI FUNCTIONS (Tabs, Vol, Undo, URL)
 * ==========================================
 */
// Tabs
function renderTabs() {
    const list = document.getElementById('tabList');
    list.innerHTML = "";
    tabs.forEach((t, i) => {
        const div = document.createElement('div');
        div.className = `tab-item ${i === currentTab ? 'active' : ''}`;
        div.innerHTML = `
            <span onclick="swapTab(${i})">${t.name}</span>
            <span class="tab-edit" onclick="renameTab(${i})">Á∑®ÈõÜ</span>
        `;
        list.appendChild(div);
    });
}
function swapTab(i) {
    currentTab = i;
    renderTabs();
    updateInputFromTab();
    parseItems();
    drawRoulette();
}
function renameTab(i) {
    const n = prompt("„Çø„ÉñÂêç„ÇíÂ§âÊõ¥:", tabs[i].name);
    if(n) { tabs[i].name = n; renderTabs(); }
}
function updateInputFromTab() {
    document.getElementById('inputs').value = tabs[currentTab].content;
}

// Volume Game
function dropVolume() {
    const ball = document.getElementById('volBall');
    ball.style.display = 'block';
    ball.style.top = '0px';
    ball.style.left = Math.random() * 90 + '%';
    
    let y = 0;
    let speed = 2;
    const interval = setInterval(() => {
        y += speed;
        speed += 1;
        ball.style.top = y + 'px';
        if (y > 70) { // Hit bottom
            clearInterval(interval);
            const rect = document.getElementById('volBox').getBoundingClientRect();
            const ballRect = ball.getBoundingClientRect();
            const relativeX = ballRect.left - rect.left;
            const pct = Math.max(0, Math.min(1, relativeX / rect.width));
            
            globalVol = pct;
            alert(`Èü≥Èáè„Åå ${Math.round(pct*100)}% „Å´„Å™„Çä„Åæ„Åó„Åü`);
        }
    }, 20);
}
function toggleMute() {
    isMuted = !isMuted;
    alert(isMuted ? "MUTE ON" : "MUTE OFF");
}

// History
function renderHistory() {
    const ul = document.getElementById('historyUl');
    ul.innerHTML = "";
    historyLog.forEach(h => {
        const li = document.createElement('li');
        li.innerText = h;
        ul.appendChild(li);
    });
}

// URL Gen
function genUrl() {
    const data = { t: tabs, c: currentTab };
    const str = JSON.stringify(data);
    const b64 = btoa(encodeURIComponent(str));
    window.location.hash = b64;
    navigator.clipboard.writeText(window.location.href);
    alert("URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅüîó");
}
function loadHash() {
    if(window.location.hash) {
        try {
            const str = decodeURIComponent(atob(window.location.hash.substring(1)));
            const data = JSON.parse(str);
            if(data.t) tabs = data.t;
            if(data.c !== undefined) currentTab = data.c;
        } catch(e) {}
    }
}

// Reset & Undo
function resetAll() {
    if(confirm("ÂÖ®Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü")) {
        prevContent = tabs[currentTab].content;
        tabs[currentTab].content = "";
        updateInputFromTab();
        parseItems();
        drawRoulette();
        resetChaosStyles();
    }
}
function undo() {
    if(prevContent) {
        tabs[currentTab].content = prevContent;
        updateInputFromTab();
        parseItems();
        drawRoulette();
    }
}

/**
 * ==========================================
 * BACKGROUND ANIMATION
 * ==========================================
 */
const bgCvs = document.getElementById('bgCanvas');
const bgCtx = bgCvs.getContext('2d');
let shapes = [];

function drawBackground() {
    bgCvs.width = window.innerWidth;
    bgCvs.height = window.innerHeight;
    for(let i=0; i<40; i++) shapes.push(new Shape());
}

class Shape {
    constructor() { this.reset(); }
    reset() {
        this.x = Math.random() * bgCvs.width;
        this.y = Math.random() * -500;
        this.size = Math.random() * 20 + 5;
        this.speed = Math.random() * 1.5 + 0.5;
        this.color = COLORS[Math.floor(Math.random() * COLORS.length)];
        this.type = Math.floor(Math.random()*3); // 0:cir, 1:rect, 2:tri
    }
    update() {
        this.y += this.speed;
        if(this.y > bgCvs.height) this.reset();
    }
    draw() {
        bgCtx.fillStyle = this.color;
        bgCtx.globalAlpha = 0.6;
        bgCtx.beginPath();
        if(this.type===0) bgCtx.arc(this.x, this.y, this.size, 0, 7);
        else if(this.type===1) bgCtx.fillRect(this.x, this.y, this.size, this.size);
        else {
            bgCtx.moveTo(this.x, this.y);
            bgCtx.lineTo(this.x+this.size, this.y+this.size);
            bgCtx.lineTo(this.x-this.size, this.y+this.size);
        }
        bgCtx.fill();
    }
}

function animBackground() {
    bgCtx.clearRect(0,0,bgCvs.width,bgCvs.height);
    shapes.forEach(s => { s.update(); s.draw(); });
    requestAnimationFrame(animBackground);
}
window.onresize = () => { bgCvs.width = window.innerWidth; bgCvs.height = window.innerHeight; };

</script>
</body>
</html>
