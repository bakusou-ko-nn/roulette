<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>究極のルーレット V2準拠版</title>
<style>
  :root {
    --bg-white: #ffffff;
    --vivid-blue: #4ECDC4;
    --vivid-red: #FF6B6B;
    --active-teal: #B2DFDB;
    --pastel: ["#FFB3BA", "#FFDFBA", "#FFFFBA", "#BAFFC9", "#BAE1FF", "#E2F0CB"];
  }

  body {
    margin: 0; padding: 0;
    font-family: 'Helvetica Neue', Arial, sans-serif;
    background-color: var(--bg-white);
    overflow: hidden;
    height: 100vh;
    display: flex; justify-content: center;
  }

  /* 背景幾何学 */
  #bg-canvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1; opacity: 0.4; pointer-events: none;
  }

  #layout {
    display: flex; width: 98vw; height: 95vh; gap: 20px; padding: 10px;
  }

  /* --- 左パネル --- */
  #left-panel {
    width: 20%; display: flex; flex-direction: column; gap: 10px;
  }
  .vol-box {
    display: flex; flex-direction: column; align-items: center;
    background: #f8f8f8; padding: 10px; border-radius: 15px; border: 1px solid #ddd;
  }
  input[type="range"] {
    writing-mode: bt-lr; -webkit-appearance: slider-vertical;
    width: 10px; height: 150px; accent-color: var(--vivid-blue);
  }
  .tab-item {
    padding: 12px; background: white; border: 2px solid #eee;
    border-radius: 10px; cursor: pointer; text-align: center; font-weight: bold;
  }
  .tab-item.active {
    background: var(--active-teal); border-color: var(--vivid-blue); border-radius: 20px;
  }

  /* --- 中央メイン（指示通りの配置順） --- */
  #main-panel {
    flex: 1; display: flex; flex-direction: column; align-items: center;
  }

  /* 1. 記入スペース（一番上） */
  #input-area {
    width: 90%; height: 80px; margin-bottom: 15px;
    border-radius: 15px; border: 2px solid #ddd; padding: 10px;
    font-size: 16px; resize: none; outline: none;
  }

  /* 2. 結果内容（入力欄の下） */
  #result-box {
    font-size: 50px; font-weight: 900; color: #333;
    min-height: 70px; margin-bottom: 5px; text-align: center;
    text-decoration: underline 6px var(--vivid-red); text-underline-offset: 10px;
  }

  /* 3 & 4. 判定▼ と 円盤 */
  #wheel-wrapper {
    position: relative; cursor: pointer;
  }
  #indicator {
    position: absolute; top: -15px; left: 50%;
    transform: translateX(-50%); width: 0; height: 0;
    border-left: 25px solid transparent; border-right: 25px solid transparent;
    border-top: 35px solid var(--vivid-red); /* 下向きの▼ */
    z-index: 50; filter: drop-shadow(0 3px 3px rgba(0,0,0,0.2));
  }
  canvas#wheel { border-radius: 50%; }

  /* --- 右パネル：履歴 --- */
  #right-panel { width: 20%; display: flex; flex-direction: column; }
  #history-box {
    flex: 1; border: 3px solid var(--vivid-red); border-radius: 25px;
    background: white; padding: 15px; overflow-y: auto;
  }
  #history-list { list-style: none; padding: 0; font-size: 22px; font-weight: bold; }
  #history-list li { padding: 8px 0; border-bottom: 1px dashed #ffdada; }

  /* 演出用 */
  #fx-canvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 40;
  }
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>

<div id="layout">
  <div id="left-panel">
    <div class="vol-box">
      <span>大</span>
      <input type="range" id="vol" min="0" max="1" step="0.1" value="0.5">
      <span>小</span>
    </div>
    <div id="tabs" style="display:flex; flex-direction:column; gap:8px; flex:1;"></div>
    <button style="background:var(--vivid-blue); color:white; border:none; padding:10px; border-radius:10px; cursor:pointer;" onclick="share()">URL発行</button>
  </div>

  <div id="main-panel">
    <textarea id="input-area" placeholder="項目を改行で入力..."></textarea>
    <div id="result-box"></div>
    <div id="wheel-wrapper" onclick="spin()">
      <div id="indicator"></div>
      <canvas id="wheel" width="500" height="500"></canvas>
    </div>
    <canvas id="fx-canvas"></canvas>
  </div>

  <div id="right-panel">
    <div id="history-box">
      <div style="text-align:center; color:var(--vivid-red); font-weight:bold; margin-bottom:10px;">履歴</div>
      <ul id="history-list"></ul>
    </div>
  </div>
</div>

<script>
  let state = {
    tabs: [{ name: "ルーレット1", items: ["A", "B", "C"] }],
    current: 0,
    angle: 0,
    spinning: false,
    history: []
  };

  const colors = ["#FFB3BA", "#FFDFBA", "#FFFFBA", "#BAFFC9", "#BAE1FF", "#E2F0CB"];
  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  const audio = new (window.AudioContext || window.webkitAudioContext)();

  function init() {
    renderTabs();
    updateInput();
    drawBG();
  }

  function renderTabs() {
    const box = document.getElementById('tabs');
    box.innerHTML = state.tabs.map((t, i) => `
      <div class="tab-item ${i===state.current?'active':''}" onclick="state.current=${i};renderTabs();updateInput();">${t.name}</div>
    `).join('');
  }

  function updateInput() {
    document.getElementById('input-area').value = state.tabs[state.current].items.join('\n');
    drawWheel();
  }

  function drawWheel(hit = -1) {
    const items = state.tabs[state.current].items;
    if(!items.length) return;
    const step = (Math.PI * 2) / items.length;
    ctx.clearRect(0,0,500,500);
    items.forEach((txt, i) => {
      ctx.beginPath(); ctx.moveTo(250, 250);
      ctx.arc(250, 250, 240, state.angle + i*step, state.angle + (i+1)*step);
      ctx.fillStyle = (i === hit) ? "#FF0080" : colors[i % colors.length];
      ctx.fill(); ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; ctx.stroke();
      ctx.save(); ctx.translate(250,250); ctx.rotate(state.angle + i*step + step/2);
      ctx.fillStyle = "#333"; ctx.font = "bold 20px sans-serif"; ctx.textAlign = "right";
      ctx.fillText(txt.slice(0,8), 220, 10); ctx.restore();
    });
    ctx.beginPath(); ctx.arc(250, 250, 25, 0, Math.PI*2); ctx.fillStyle = "white"; ctx.fill();
  }

  function spin() {
    if(state.spinning || state.tabs[state.current].items.length < 2) return;
    state.spinning = true;
    document.getElementById('result-box').textContent = "";
    let speed = Math.random() * 0.4 + 0.4;
    const loop = () => {
      state.angle += speed; speed *= 0.985;
      playSE('roll');
      if(speed < 0.003) {
        state.spinning = false;
        const items = state.tabs[state.current].items;
        const step = (Math.PI * 2) / items.length;
        const hit = Math.floor(((Math.PI * 1.5 - state.angle % (Math.PI*2)) + Math.PI*2) % (Math.PI*2) / step);
        drawWheel(hit);
        document.getElementById('result-box').textContent = items[hit];
        playSE('win');
        addHistory(items[hit]);
        return;
      }
      drawWheel(); requestAnimationFrame(loop);
    };
    loop();
  }

  function addHistory(txt) {
    state.history.unshift(txt);
    document.getElementById('history-list').innerHTML = state.history.slice(0,15).map(h=>`<li>${h}</li>`).join('');
  }

  function playSE(type) {
    const vol = document.getElementById('vol').value;
    if(vol == 0) return;
    const osc = audio.createOscillator();
    const g = audio.createGain();
    osc.connect(g); g.connect(audio.destination);
    if(type==='roll') {
      osc.type='sawtooth'; osc.frequency.value=80;
      g.gain.setValueAtTime(vol*0.1, audio.currentTime);
      osc.start(); osc.stop(audio.currentTime+0.05);
    } else {
      [523, 659, 783].forEach((f,i)=>{
        const o=audio.createOscillator(); const gain=audio.createGain();
        o.connect(gain); gain.connect(audio.destination);
        o.frequency.value=f; gain.gain.value=vol*0.3;
        o.start(audio.currentTime+i*0.1); o.stop(audio.currentTime+0.5);
      });
    }
  }

  document.getElementById('input-area').oninput = (e) => {
    state.tabs[state.current].items = e.target.value.split('\n').filter(v=>v.trim());
    drawWheel();
  };

  function drawBG() {
    const c = document.getElementById('bg-canvas');
    const bctx = c.getContext('2d');
    c.width = window.innerWidth; c.height = window.innerHeight;
    for(let i=0; i<30; i++) {
      bctx.fillStyle = colors[i%colors.length]; bctx.globalAlpha=0.2;
      bctx.fillRect(Math.random()*c.width, Math.random()*c.height, 30, 30);
    }
  }

  init();
</script>
</body>
</html>
