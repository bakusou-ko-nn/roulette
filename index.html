<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹å‘½ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼šã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ãƒƒãƒˆãƒ»ã‚«ã‚ªã‚¹</title>
    <style>
        :root {
            /* ãƒ‘ã‚¹ãƒ†ãƒ«ã‚«ãƒ©ãƒ¼ï¼ˆåŸè‰²30%ç¨‹åº¦ï¼‰ */
            --c-red: #ffb3ba; --c-yellow: #ffffba; --c-orange: #ffdfba;
            --c-blue: #bae1ff; --c-purple: #e2baff; --c-green: #baffc9; --c-gray: #e0e0e0;
            --bg-border: #888;
            --tab-border: #145a32; /* æ·±ç·‘ */
            --mint-active: #d1fbd1; /* è–„ã„ãƒŸãƒ³ãƒˆ */
            --font-main: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
        }

        body {
            margin: 0; padding: 0; font-family: var(--font-main);
            background-color: #fff; overflow: hidden;
            height: 100vh; display: flex; justify-content: center; align-items: center;
            transition: background 1s ease, filter 0.2s;
        }

        /* èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; pointer-events: none; }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚†ã£ãŸã‚Šé…ç½®ï¼‰ */
        .container {
            display: grid; grid-template-columns: 280px 1fr 280px; gap: 60px;
            width: 95%; max-width: 1600px; height: 90vh;
            position: relative; z-index: 10;
        }

        /* --- å·¦ãƒ‘ãƒãƒ«ï¼ˆæ“ä½œç³»ï¼‰ --- */
        .left-panel { display: flex; flex-direction: column; justify-content: center; gap: 20px; }

        /* éŸ³é‡ã‚¨ãƒªã‚¢ */
        .vol-area {
            border: 1px solid #ccc; padding: 15px; border-radius: 12px; background: rgba(255,255,255,0.9);
            text-align: center; margin-bottom: 20px; position: relative;
        }
        .vol-bar-wrap {
            width: 100%; height: 20px; background: #eee; border-radius: 10px;
            margin: 10px 0; position: relative; overflow: hidden;
        }
        #volLevel { width: 50%; height: 100%; background: #4a90e2; transition: width 0.3s; }
        #volBall {
            width: 16px; height: 16px; background: #ff4444; border-radius: 50%;
            position: absolute; top: -30px; left: 0; display: none; pointer-events: none;
        }

        /* ã‚¿ãƒ–ã‚¨ãƒªã‚¢ */
        .tabs { display: flex; flex-direction: column; gap: 12px; }
        .tab-item {
            padding: 12px 15px; border: 1px solid var(--tab-border); background: #fff;
            cursor: pointer; border-radius: 5px; transition: 0.3s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .tab-item.active {
            background-color: var(--mint-active); border-radius: 15px; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tab-name { flex-grow: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .edit-icon { font-size: 12px; color: #888; padding: 4px; cursor: pointer; }
        .edit-icon:hover { color: #333; }

        /* ã‚·ã‚¹ãƒ†ãƒ ãƒœã‚¿ãƒ³ */
        .sys-btns { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .btn-url { background: var(--c-blue); color: #333; }
        .btn-reset { background: var(--c-red); color: #333; margin-top: 20px; }
        .btn-undo { background: var(--c-yellow); font-size: 12px; margin-top: -5px; }
        .btn:hover { filter: brightness(0.9); transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }

        /* --- ä¸­å¤®ãƒ‘ãƒãƒ«ï¼ˆãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼‰ --- */
        .center-panel { display: flex; flex-direction: column; align-items: center; position: relative; }
        
        .res-display {
            font-size: 42px; font-weight: bold; color: #333; height: 60px;
            margin-bottom: 10px; text-shadow: 2px 2px 0px #fff; z-index: 20;
            text-align: center; width: 100%;
        }

        .roulette-wrapper { position: relative; margin-bottom: 30px; transition: transform 0.3s; }
        #needle {
            position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
            font-size: 50px; color: #ff4444; z-index: 5;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }
        canvas#rCanvas {
            border-radius: 50%; border: 10px solid var(--c-gray);
            background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        #spinBtn {
            width: 240px; height: 70px; font-size: 24px; font-weight: bold;
            background: #4caf50; color: white; border: none; border-bottom: 6px solid #2e7d32;
            border-radius: 12px; cursor: pointer; margin-bottom: 20px;
        }
        #spinBtn:active { transform: translateY(4px); border-bottom-width: 2px; }

        textarea#itemsInput {
            width: 100%; height: 120px; padding: 15px; border: 2px solid #ddd;
            border-radius: 10px; font-size: 16px; resize: none; outline: none;
            background: rgba(255,255,255,0.8);
        }

        /* --- å³ãƒ‘ãƒãƒ«ï¼ˆå±¥æ­´ï¼‰ --- */
        .right-panel { display: flex; flex-direction: column; justify-content: center; }
        .hist-box {
            border: 2px solid #ff4444; border-radius: 20px; padding: 0;
            background: rgba(255,255,255,0.9); height: 500px; overflow: hidden;
            display: flex; flex-direction: column; width: 100%;
        }
        .hist-header {
            background: #ffeeee; padding: 10px; text-align: center;
            font-weight: bold; color: #d32f2f; border-bottom: 1px solid #ffb3ba;
        }
        .hist-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .hist-list li {
            padding: 10px; border-bottom: 1px dashed #ffb3ba; text-align: center;
            font-size: 14px; animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ã‚¯ã‚½ä»•æ§˜æ¼”å‡ºç”¨ã‚¯ãƒ©ã‚¹ --- */
        .chaos-ghost { opacity: 0.5; filter: blur(2px); pointer-events: none; }
        .chaos-spin-reverse { animation: spinRev 0.5s linear infinite; }
        @keyframes spinRev { 0% { transform: rotate(0deg); } 100% { transform: rotate(-360deg); } }
        
        /* ç‰©ç†å´©å£Š */
        .mode-gravity { transition: transform 1s ease-in !important; transform: translateY(150vh) rotate(20deg); }
        .mode-explode { animation: explode 0.5s forwards; }
        @keyframes explode { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(3); opacity: 0; } }
        
        /* è¦–è¦šãƒã‚° */
        .mode-invert { filter: invert(1); }
        .mode-mosaic { filter: blur(10px) contrast(200%); }
        .mode-flash { animation: flashBang 0.2s; }
        @keyframes flashBang { 0%, 100% { background: white; } 50% { background: #fff; filter: brightness(100); } }
        .mode-dark { background: #000 !important; }
        .mode-dark .res-display, .mode-dark textarea { color: #fff; background: #333; }
        .mode-dark canvas { filter: brightness(0.5); }
        
        /* å«ŒãŒã‚‰ã› */
        #fakeAd {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 600px; height: 400px; background: #ffeb3b; border: 10px solid red;
            z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center;
            font-size: 30px; font-weight: bold; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        #adClose { font-size: 150px; color: red; cursor: pointer; line-height: 1; }

    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div id="fakeAd">
    <p>ğŸš¨ å½“é¸ç¢ºç‡ 999% UP!! ğŸš¨</p>
    <div id="adClose" onclick="closeAd()">Ã—</div>
    <p style="font-size:12px;">(åºƒå‘Šã‚’é–‰ã˜ã‚‹)</p>
</div>

<div class="container">
    <div class="left-panel">
        <div class="vol-area">
            <div>ğŸ”Š VOLUME</div>
            <div class="vol-bar-wrap" id="volWrap">
                <div id="volLevel"></div>
                <div id="volBall"></div>
            </div>
            <button class="btn" style="background:#eee; width:100%;" onclick="dropVolBall()">ãƒœãƒ¼ãƒ«æŠ½é¸</button>
            <button class="btn" style="margin-top:5px; width:100%; font-size:12px;" onclick="toggleMute()" id="muteBtn">ãƒŸãƒ¥ãƒ¼ãƒˆ: OFF</button>
        </div>

        <div class="tabs" id="tabContainer"></div>

        <div class="sys-btns">
            <button class="btn btn-url" onclick="generateURL()">ğŸ”— URLç™ºè¡Œ (ã‚³ãƒ”ãƒ¼)</button>
            <button class="btn btn-reset" onclick="resetItems()">âš ï¸ å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="btn btn-undo" onclick="undoReset()">â†©ï¸ å…ƒã«æˆ»ã™</button>
        </div>
    </div>

    <div class="center-panel">
        <div class="res-display" id="resultText">READY</div>
        
        <div class="roulette-wrapper" id="rWrapper">
            <div id="needle">â–¼</div>
            <canvas id="rCanvas" width="500" height="500"></canvas>
        </div>

        <button id="spinBtn" onclick="trySpin()">SPIN!</button>
        <textarea id="itemsInput" placeholder="é …ç›®ã‚’æ”¹è¡Œã§å…¥åŠ›ã—ã¦ãã ã•ã„...&#10;æœ€å¤§500ä»¶"></textarea>
    </div>

    <div class="right-panel">
        <div class="hist-box">
            <div class="hist-header">HISTORY (Latest 10)</div>
            <ul class="hist-list" id="histList"></ul>
        </div>
    </div>
</div>

<script>
/**
 * è¨­å®šãƒ»å®šæ•°
 */
const COLORS = [
    '#ffb3ba', // èµ¤
    '#ffffba', // é»„
    '#ffdfba', // æ©™
    '#bae1ff', // é’
    '#e2baff', // ç´«
    '#baffc9', // ç·‘
    '#e0e0e0'  // ç°
];

// çŠ¶æ…‹ç®¡ç†
let state = {
    tabs: [
        { name: "ãƒªã‚¹ãƒˆ1", content: "å¤§å‰\nä¸­å‰\nå°å‰\nå‰\næœ«å‰\nå‡¶" },
        { name: "ãƒªã‚¹ãƒˆ2", content: "" },
        { name: "ãƒªã‚¹ãƒˆ3", content: "" },
        { name: "ãƒªã‚¹ãƒˆ4", content: "" },
        { name: "ãƒªã‚¹ãƒˆ5", content: "" }
    ],
    currentTab: 0,
    volume: 0.5,
    muted: false,
    history: [],
    lastDeletedContent: ""
};

let items = [];
let isSpinning = false;
let chaosMode = null; // ç¾åœ¨ã®ã‚¯ã‚½ã‚¤ãƒ™ãƒ³ãƒˆID
let clickSpamCount = 0;

// DOMè¦ç´ 
const canvas = document.getElementById('rCanvas');
const ctx = canvas.getContext('2d');
const resultText = document.getElementById('resultText');
const itemsInput = document.getElementById('itemsInput');
const histList = document.getElementById('histList');
const rWrapper = document.getElementById('rWrapper');

/**
 * åˆæœŸåŒ–
 */
window.onload = () => {
    // URLãƒãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒ
    loadFromHash();
    
    // èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    initBg();
    
    // åˆæœŸæç”»
    renderTabs();
    loadTab(state.currentTab);
    updateVolumeUI();
    
    // å…¥åŠ›ç›£è¦–
    itemsInput.addEventListener('input', () => {
        state.tabs[state.currentTab].content = itemsInput.value;
        parseItems();
        drawRoulette();
    });
};

/**
 * ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæç”»ãƒ­ã‚¸ãƒƒã‚¯
 */
function parseItems() {
    const raw = itemsInput.value;
    items = raw.split('\n').map(t => t.trim()).filter(t => t !== "").slice(0, 500);
}

function drawRoulette(rotation = 0) {
    const w = canvas.width;
    const h = canvas.height;
    const cx = w / 2;
    const cy = h / 2;
    const r = (w / 2) - 10;

    ctx.clearRect(0, 0, w, h);

    if (items.length === 0) {
        ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.fillStyle = "#f9f9f9"; ctx.fill();
        ctx.textAlign = "center"; ctx.fillStyle = "#ccc"; ctx.font = "30px Arial";
        ctx.fillText("é …ç›®ã‚’å…¥åŠ›", cx, cy);
        return;
    }

    const arc = (Math.PI * 2) / items.length;

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæç”»
    for (let i = 0; i < items.length; i++) {
        const angle = rotation + (i * arc);
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, angle, angle + arc);
        ctx.fillStyle = COLORS[i % COLORS.length];
        ctx.fill();
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.stroke();

        // æ–‡å­—æç”»
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#333";
        ctx.font = "bold 24px var(--font-main)";
        // é•·ã„æ–‡å­—ã¯çœç•¥
        let text = items[i];
        if (text.length > 10) text = text.substring(0, 10) + "..";
        ctx.fillText(text, r - 30, 8);
        ctx.restore();
    }
}

/**
 * ã‚¹ãƒ”ãƒ³å‡¦ç†ã¨ã‚¤ãƒ™ãƒ³ãƒˆ
 */
async function trySpin() {
    if (isSpinning) return;
    if (items.length === 0) { alert("é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    // 20%ã§ã‚¯ã‚½ã‚¤ãƒ™ãƒ³ãƒˆæŠ½é¸
    chaosMode = Math.random() < 0.2 ? Math.floor(Math.random() * 15) : -1;
    // chaosMode = 4; // ãƒ‡ãƒãƒƒã‚°ç”¨

    // ã‚¹ãƒ”ãƒ³å‰ã‚¤ãƒ™ãƒ³ãƒˆ
    if (chaosMode === 10) { // ã‚¯ãƒªãƒƒã‚¯é€£æ‰“è¦æ±‚
        if (clickSpamCount < 100) {
            clickSpamCount++;
            resultText.innerText = `ã‚ã¨${100 - clickSpamCount}å›é€£æ‰“ã—ã‚`;
            return;
        }
        clickSpamCount = 0;
    }
    if (chaosMode === 11) { // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåœ°ç„
        for(let i=0; i<10; i++) { if(!confirm(`æœ¬å½“ã«å›ã—ã¾ã™ã‹ï¼Ÿ (${i+1}/10)`)) return; }
    }
    if (chaosMode === 12) { // åºƒå‘Š
        document.getElementById('fakeAd').style.display = 'flex';
        return; // åºƒå‘Šé–‰ã˜ãªã„ã¨é€²ã¾ãªã„
    }

    startSpin();
}

function closeAd() {
    document.getElementById('fakeAd').style.display = 'none';
    startSpin();
}

function startSpin() {
    isSpinning = true;
    resetEffects();
    
    // éŸ³å†ç”Ÿ (ãƒ†ã‚£ãƒ³ãƒ‘ãƒ‹)
    const rollSound = new Audio("https://soundeffect-lab.info/sound/anime/mp3/tympani-roll1.mp3");
    rollSound.volume = state.muted ? 0 : state.volume;
    // å«ŒãŒã‚‰ã›ï¼šéŸ³é‡é€†è»¢
    if (chaosMode === 13 && !state.muted) rollSound.volume = 1.0; 
    
    rollSound.loop = true;
    rollSound.play().catch(e => console.log("Audio play blocked"));

    // æŠ½é¸
    const winIndex = Math.floor(Math.random() * items.length);
    const arc = (Math.PI * 2) / items.length;
    // é‡ã¯ä¸Š(270åº¦ = 1.5PI)ã«ã‚ã‚‹ã€‚
    // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè§’åº¦è¨ˆç®—: 
    // åŸºæœ¬å›è»¢æ•° + (270åº¦ - å½“é¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä¸­å¿ƒè§’)
    // è£œæ­£ï¼šæ™‚è¨ˆå›ã‚Šã«å›ã‚‹ã®ã§ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¯ãƒã‚¤ãƒŠã‚¹æ–¹å‘ã¸è¨ˆç®—ã™ã‚‹ã»ã†ãŒæ¥½ã ãŒã€
    // ã“ã“ã§ã¯å˜ç´”ã«ã€Œä½•å›è»¢ã—ã¦ã©ã“ã§æ­¢ã¾ã‚‹ã‹ã€ã‚’è¨ˆç®—ã€‚
    const baseRotations = 5 + Math.random() * 5;
    const targetAngle = (baseRotations * Math.PI * 2) + (1.5 * Math.PI - (winIndex * arc) - (arc/2));

    const duration = 5000; // 5ç§’
    const startTime = performance.now();

    // ã‚¤ãƒ™ãƒ³ãƒˆï¼šé€æ˜åŒ–
    if (chaosMode === 14) rWrapper.style.opacity = "0";

    function animate(time) {
        const elapsed = time - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚° (easeOutQuart)
        const ease = 1 - Math.pow(1 - progress, 4);
        
        let currentRotation = targetAngle * ease;

        // ã‚¤ãƒ™ãƒ³ãƒˆï¼šé€†å™´å°„
        if (chaosMode === 2) currentRotation *= -1;

        // ã‚¤ãƒ™ãƒ³ãƒˆï¼šä½è§£åƒåº¦
        if (chaosMode === 8) {
            const blur = Math.floor(progress * 20);
            canvas.style.filter = `blur(${blur}px)`;
        }

        drawRoulette(currentRotation);

        if (progress < 1) {
            // ã‚¤ãƒ™ãƒ³ãƒˆï¼šæ€¥åœæ­¢ï¼ˆ50%ã§æ­¢ã¾ã‚‹ï¼‰
            if (chaosMode === 0 && progress > 0.5) {
                finalizeSpin(winIndex, rollSound);
            } else {
                requestAnimationFrame(animate);
            }
        } else {
            finalizeSpin(winIndex, rollSound);
        }
    }
    requestAnimationFrame(animate);
}

function finalizeSpin(winIndex, rollSound) {
    rollSound.pause();
    rollSound.currentTime = 0;

    // ã‚¤ãƒ™ãƒ³ãƒˆï¼šåˆ†è£‚ï¼ˆæ®‹åƒï¼‰
    if (chaosMode === 6) {
        // ç°¡æ˜“çš„ã«CSSã§è¡¨ç¾
        rWrapper.style.boxShadow = "20px 0 0 red, -20px 0 0 blue";
    }

    // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
    const winSound = new Audio("https://soundeffect-lab.info/sound/anime/mp3/jean1.mp3");
    let vol = state.muted ? 0 : state.volume;
    if (chaosMode === 13 && !state.muted) vol = 1.0; // çˆ†éŸ³
    winSound.volume = vol;
    winSound.play().catch(()=>{});

    // çµæœè¡¨ç¤º
    const winItem = items[winIndex];
    let displayText = winItem;

    // ã‚¤ãƒ™ãƒ³ãƒˆï¼šæ–‡å­—åŒ–ã‘
    if (chaosMode === 4) displayText = "â–¯â–¯â–¯â–¯â–¯â–¯";
    // ã‚¤ãƒ™ãƒ³ãƒˆï¼šçˆ†ç™º
    if (chaosMode === 5) {
        displayText = "ãƒ‰ã‚«ãƒ¼ãƒ³ï¼";
        rWrapper.classList.add("mode-explode");
    }
    // ã‚¤ãƒ™ãƒ³ãƒˆï¼šã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Š
    if (chaosMode === 7) {
        items = items.map(() => winItem);
        drawRoulette();
    }

    resultText.innerText = displayText;

    // èƒŒæ™¯å¤‰æ›´
    const winColor = COLORS[winIndex % COLORS.length];
    document.body.style.background = `linear-gradient(to bottom, #fff 0%, ${winColor} 100%)`;

    // å±¥æ­´è¿½åŠ 
    addToHistory(winItem);

    isSpinning = false;

    // ã‚¹ãƒ”ãƒ³å¾Œã‚¤ãƒ™ãƒ³ãƒˆ
    // é‡åŠ›
    if (chaosMode === 3) rWrapper.classList.add("mode-gravity");
    // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
    if (chaosMode === 5) document.body.classList.add("mode-flash");
    // è‰²åè»¢
    if (chaosMode === 9) document.body.classList.add("mode-invert");
    // æš—é—‡
    if (chaosMode === 12) document.body.classList.add("mode-dark");

    // å¼·åˆ¶ã‚„ã‚Šç›´ã—
    if (chaosMode === 15) {
        setTimeout(() => {
            alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚");
            resetEffects();
            resultText.innerText = "READY";
        }, 1000);
    }
}

function resetEffects() {
    rWrapper.className = "roulette-wrapper";
    rWrapper.style.opacity = "1";
    rWrapper.style.boxShadow = "none";
    canvas.style.filter = "none";
    document.body.className = "";
    document.body.style.background = "#fff";
}

/**
 * UIæ©Ÿèƒ½ç¾¤
 */

// ã‚¿ãƒ–
function renderTabs() {
    const container = document.getElementById('tabContainer');
    container.innerHTML = "";
    state.tabs.forEach((tab, idx) => {
        const div = document.createElement('div');
        div.className = `tab-item ${idx === state.currentTab ? 'active' : ''}`;
        div.onclick = () => loadTab(idx);
        
        const nameSpan = document.createElement('span');
        nameSpan.className = "tab-name";
        nameSpan.innerText = tab.name;
        
        const editIcon = document.createElement('span');
        editIcon.className = "edit-icon";
        editIcon.innerText = "âœï¸";
        editIcon.onclick = (e) => {
            e.stopPropagation();
            const newName = prompt("ã‚¿ãƒ–åã‚’å¤‰æ›´:", tab.name);
            if(newName) {
                tab.name = newName;
                renderTabs();
            }
        };

        div.appendChild(nameSpan);
        div.appendChild(editIcon);
        container.appendChild(div);
    });
}

function loadTab(idx) {
    state.currentTab = idx;
    itemsInput.value = state.tabs[idx].content;
    parseItems();
    drawRoulette();
    renderTabs();
}

// éŸ³é‡ç‰©ç†æŠ½é¸
function dropVolBall() {
    const ball = document.getElementById('volBall');
    const wrap = document.getElementById('volWrap');
    const maxW = wrap.clientWidth;
    
    ball.style.display = 'block';
    
    // ç‰©ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ•°
    let x = Math.random() * (maxW - 20);
    let y = -30;
    let vy = 0;
    const gravity = 1.5;
    const ground = 0; // relative to wrap top (actually wrap height is small) -> visual trick

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    let animId = setInterval(() => {
        vy += gravity;
        y += vy;
        ball.style.top = y + 'px';
        ball.style.left = x + 'px';

        if (y >= 0) { // ç€åœ°
            clearInterval(animId);
            state.volume = x / maxW;
            if(state.volume > 1) state.volume = 1;
            if(state.volume < 0) state.volume = 0;
            updateVolumeUI();
            ball.style.display = 'none';
        }
    }, 20);
}

function updateVolumeUI() {
    const pct = Math.round(state.volume * 100);
    document.getElementById('volLevel').style.width = pct + "%";
}

function toggleMute() {
    state.muted = !state.muted;
    document.getElementById('muteBtn').innerText = state.muted ? "ãƒŸãƒ¥ãƒ¼ãƒˆ: ON" : "ãƒŸãƒ¥ãƒ¼ãƒˆ: OFF";
}

// å±¥æ­´
function addToHistory(text) {
    state.history.unshift(text);
    if (state.history.length > 10) state.history.pop();
    renderHistory();
}

function renderHistory() {
    histList.innerHTML = "";
    state.history.forEach(h => {
        const li = document.createElement('li');
        li.innerText = h;
        histList.appendChild(li);
    });
}

// ãƒªã‚»ãƒƒãƒˆ & Undo
function resetItems() {
    if(!confirm("ç¾åœ¨ã®ã‚¿ãƒ–ã®å†…å®¹ã‚’æ¶ˆå»ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
    state.lastDeletedContent = itemsInput.value;
    itemsInput.value = "";
    state.tabs[state.currentTab].content = "";
    parseItems();
    drawRoulette();
}

function undoReset() {
    if(state.lastDeletedContent === "") return;
    itemsInput.value = state.lastDeletedContent;
    state.tabs[state.currentTab].content = state.lastDeletedContent;
    state.lastDeletedContent = "";
    parseItems();
    drawRoulette();
}

// URLç™ºè¡Œ (JSON -> Base64)
function generateURL() {
    // çŠ¶æ…‹ã‚’JSONåŒ–
    const json = JSON.stringify(state.tabs);
    // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ (æ—¥æœ¬èªå¯¾å¿œ)
    const base64 = btoa(unescape(encodeURIComponent(json)));
    const url = window.location.origin + window.location.pathname + "#" + base64;
    
    navigator.clipboard.writeText(url).then(() => {
        alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n(é•·ã„ã§ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãŒå…¨ã¦å…¥ã£ã¦ã„ã‚‹ãŸã‚æœ‰åŠ¹ã§ã™)");
    });
}

function loadFromHash() {
    if(window.location.hash) {
        try {
            const base64 = window.location.hash.substring(1);
            const json = decodeURIComponent(escape(atob(base64)));
            const savedTabs = JSON.parse(json);
            if(Array.isArray(savedTabs)) {
                state.tabs = savedTabs;
            }
        } catch(e) {
            console.error("URLèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e);
        }
    }
}

/**
 * èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (Canvas)
 */
let shapes = [];
function initBg() {
    const bgCvs = document.getElementById('bgCanvas');
    bgCvs.width = window.innerWidth;
    bgCvs.height = window.innerHeight;
    
    // å½¢çŠ¶ç”Ÿæˆ
    for(let i=0; i<30; i++) {
        shapes.push({
            x: Math.random() * bgCvs.width,
            y: Math.random() * bgCvs.height,
            size: Math.random() * 30 + 10,
            type: Math.floor(Math.random() * 3), // 0:å††, 1:å››è§’, 2:ä¸‰è§’
            speed: Math.random() * 2 + 0.5,
            color: COLORS[Math.floor(Math.random() * COLORS.length)]
        });
    }
    bgLoop();
}

function bgLoop() {
    const bgCvs = document.getElementById('bgCanvas');
    const bgCtx = bgCvs.getContext('2d');
    
    bgCtx.clearRect(0, 0, bgCvs.width, bgCvs.height);
    
    shapes.forEach(s => {
        s.y += s.speed;
        if(s.y > bgCvs.height + 50) {
            s.y = -50;
            s.x = Math.random() * bgCvs.width;
        }

        bgCtx.fillStyle = s.color;
        bgCtx.globalAlpha = 0.5;
        bgCtx.beginPath();
        
        if(s.type === 0) { // å††
            bgCtx.arc(s.x, s.y, s.size/2, 0, Math.PI*2);
        } else if(s.type === 1) { // å››è§’
            bgCtx.fillRect(s.x, s.y, s.size, s.size);
        } else { // ä¸‰è§’
            bgCtx.moveTo(s.x, s.y);
            bgCtx.lineTo(s.x + s.size, s.y + s.size);
            bgCtx.lineTo(s.x - s.size, s.y + s.size);
            bgCtx.closePath();
        }
        bgCtx.fill();
    });

    requestAnimationFrame(bgLoop);
}

// ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
window.onresize = () => {
    const bgCvs = document.getElementById('bgCanvas');
    bgCvs.width = window.innerWidth;
    bgCvs.height = window.innerHeight;
    drawRoulette();
};

</script>
</body>
</html>
