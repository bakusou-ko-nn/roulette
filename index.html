<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>究極のルーレット - 重なり修正版</title>
<style>
  :root {
    --vivid-blue: #4ECDC4;
    --vivid-red: #FF6B6B;
    --active-teal: #B2DFDB;
  }

  body {
    margin: 0; padding: 0;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    background-color: #fff;
    display: flex; justify-content: center; align-items: center;
    height: 100vh; overflow: hidden;
  }

  /* 背景幾何学 */
  #bg-canvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1; opacity: 0.3; pointer-events: none;
  }

  #container {
    display: flex; width: 96vw; height: 90vh; gap: 20px;
  }

  /* 左：設定 */
  #side-l { width: 20%; display: flex; flex-direction: column; gap: 10px; }
  .vol-ctrl { display: flex; flex-direction: column; align-items: center; background: #f5f5f5; padding: 10px; border-radius: 15px; }
  input[type="range"] { writing-mode: bt-lr; -webkit-appearance: slider-vertical; height: 150px; accent-color: var(--vivid-blue); }
  .tab-list { flex: 1; display: flex; flex-direction: column; gap: 8px; }
  .tab { padding: 12px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; text-align: center; font-weight: bold; }
  .tab.active { background: var(--active-teal); border-color: var(--vivid-blue); border-radius: 20px; }

  /* 中央：メイン配置 */
  #main {
    flex: 1; display: flex; flex-direction: column; align-items: center;
  }

  /* 1. 記入スペース */
  #input-box {
    width: 85%; height: 80px; margin-bottom: 10px;
    border-radius: 15px; border: 2px solid #eee; padding: 12px;
    font-size: 16px; font-family: inherit; resize: none; outline: none;
  }

  /* 2. 結果内容 */
  #result {
    font-size: 50px; font-weight: 900; color: #333;
    min-height: 70px; margin-bottom: 20px;
    text-decoration: underline 6px var(--vivid-red);
    text-underline-offset: 10px; text-align: center;
  }

  /* 3 & 4. 円盤と▼（重なり重視） */
  #wheel-wrapper {
    position: relative; cursor: pointer;
    display: flex; justify-content: center;
  }

  /* 判定の▼：円盤の上にしっかり被せる */
  #indicator {
    position: absolute;
    top: -5px; /* ここを調整して円盤に被せています */
    left: 50%; transform: translateX(-50%);
    width: 0; height: 0;
    border-left: 25px solid transparent;
    border-right: 25px solid transparent;
    border-top: 45px solid var(--vivid-red); /* 少し長めに */
    z-index: 100;
    /* 白いフチをつけて見やすく */
    filter: drop-shadow(0 0 2px white) drop-shadow(0 4px 4px rgba(0,0,0,0.2));
  }

  canvas#wheel { border-radius: 50%; }

  /* 右：履歴 */
  #side-r { width: 20%; display: flex; flex-direction: column; }
  #history-box { flex: 1; border: 4px solid var(--vivid-red); border-radius: 25px; background: #fff; padding: 15px; overflow-y: auto; }
  #history-list { list-style: none; padding: 0; font-size: 22px; font-weight: bold; }
  #history-list li { padding: 8px 0; border-bottom: 1px dashed #ffdada; }

</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>

<div id="container">
  <div id="side-l">
    <div class="vol-ctrl">
      <span>大</span>
      <input type="range" id="vol" min="0" max="1" step="0.1" value="0.5">
      <span>小</span>
      <label style="font-size:10px; margin-top:5px;"><input type="checkbox" id="snd" checked>音</label>
    </div>
    <div id="tab-list" class="tab-list"></div>
    <button onclick="genURL()" style="background:var(--vivid-blue); color:white; border:none; padding:10px; border-radius:10px; cursor:pointer; font-weight:bold;">URL発行</button>
  </div>

  <div id="main">
    <textarea id="input-box" placeholder="改行で入力..."></textarea>
    <div id="result"></div>
    <div id="wheel-wrapper" onclick="start()">
      <div id="indicator"></div>
      <canvas id="wheel" width="500" height="500"></canvas>
    </div>
  </div>

  <div id="side-r">
    <div id="history-box">
      <div style="text-align:center; color:var(--vivid-red); font-weight:bold; margin-bottom:10px;">履歴</div>
      <ul id="history-list"></ul>
    </div>
  </div>
</div>

<script>
  let state = {
    tabs: [{ name: "ルーレット1", items: ["A", "B", "C"] }],
    active: 0,
    angle: 0,
    spinning: false,
    history: []
  };

  const colors = ["#FFB3BA", "#FFDFBA", "#FFFFBA", "#BAFFC9", "#BAE1FF", "#E2F0CB", "#FFDAC1", "#E0BBE4"];
  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  const audio = new (window.AudioContext || window.webkitAudioContext)();

  function init() {
    renderTabs();
    loadContent();
    drawBG();
  }

  function renderTabs() {
    const list = document.getElementById('tab-list');
    list.innerHTML = state.tabs.map((t, i) => `
      <div class="tab ${i === state.active ? 'active' : ''}" onclick="state.active=${i};renderTabs();loadContent();">${t.name}</div>
    `).join('');
  }

  function loadContent() {
    document.getElementById('input-box').value = state.tabs[state.active].items.join('\n');
    drawWheel();
  }

  function drawWheel(hit = -1) {
    const items = state.tabs[state.active].items;
    if(!items.length) return;
    const step = (Math.PI * 2) / items.length;
    ctx.clearRect(0,0,500,500);
    items.forEach((txt, i) => {
      ctx.beginPath(); ctx.moveTo(250, 250);
      ctx.arc(250, 250, 245, state.angle + i*step, state.angle + (i+1)*step);
      ctx.fillStyle = (i === hit) ? "#FF007E" : colors[i % colors.length];
      ctx.fill(); ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; ctx.stroke();
      ctx.save(); ctx.translate(250, 250); ctx.rotate(state.angle + i*step + step/2);
      ctx.fillStyle = "#333"; ctx.font = "bold 22px sans-serif"; ctx.textAlign = "right";
      ctx.fillText(txt.slice(0, 10), 220, 8); ctx.restore();
    });
    ctx.beginPath(); ctx.arc(250, 250, 25, 0, Math.PI*2); ctx.fillStyle = "white"; ctx.fill();
  }

  function start() {
    if(state.spinning || state.tabs[state.active].items.length < 2) return;
    state.spinning = true;
    document.getElementById('result').textContent = "";
    let speed = Math.random() * 0.4 + 0.4;
    const loop = () => {
      state.angle += speed; speed *= 0.988;
      play('roll');
      if(speed < 0.0035) {
        state.spinning = false;
        const items = state.tabs[state.active].items;
        const step = (Math.PI * 2) / items.length;
        const hit = Math.floor(((Math.PI * 1.5 - state.angle % (Math.PI*2)) + Math.PI*2) % (Math.PI*2) / step);
        drawWheel(hit);
        const win = items[hit];
        document.getElementById('result').textContent = win;
        play('win');
        state.history.unshift(win);
        document.getElementById('history-list').innerHTML = state.history.slice(0,15).map(h=>`<li>${h}</li>`).join('');
        return;
      }
      drawWheel(); requestAnimationFrame(loop);
    };
    loop();
  }

  function play(type) {
    if(!document.getElementById('snd').checked) return;
    const vol = document.getElementById('vol').value;
    const g = audio.createGain(); g.connect(audio.destination);
    g.gain.setValueAtTime(vol*0.2, audio.currentTime);
    if(type==='roll') {
      const o = audio.createOscillator(); o.type='sawtooth'; o.frequency.value=80; o.connect(g);
      o.start(); o.stop(audio.currentTime+0.05);
    } else {
      [523, 659, 783].forEach((f, i) => {
        const o=audio.createOscillator(); o.connect(g); o.frequency.value=f;
        o.start(audio.currentTime+i*0.1); o.stop(audio.currentTime+0.5);
      });
    }
  }

  document.getElementById('input-box').oninput = (e) => {
    state.tabs[state.active].items = e.target.value.split('\n').filter(v=>v.trim());
    drawWheel();
  };

  function drawBG() {
    const c = document.getElementById('bg-canvas'); const b = c.getContext('2d');
    c.width = window.innerWidth; c.height = window.innerHeight;
    for(let i=0; i<30; i++) {
      b.fillStyle = colors[i%8]; b.globalAlpha=0.15;
      b.fillRect(Math.random()*c.width, Math.random()*c.height, 40, 40);
    }
  }
  init();
</script>
</body>
</html>
