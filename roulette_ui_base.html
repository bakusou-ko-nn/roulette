<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ルレット</title>

<style>
  :root{
    --bg:#eaffea;
    --pastel1:#ffd6d6;
    --pastel2:#fff3b0;
    --pastel3:#d6ffd6;
    --pastel4:#d6f0ff;
    --hit:#ff9f9f;
    --border:#ffffff;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Rounded Mplus 1c","Hiragino Maru Gothic ProN",sans-serif;
    background:var(--bg);
  }

  .app{
    display:grid;
    grid-template-columns: 1fr 2fr 1fr;
    gap:24px;
    padding:24px;
    height:100vh;
  }

  /* 左 */
  .left{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .tab{
    border:2px solid #7fd37f;
    border-radius:12px;
    padding:10px;
    background:#ffffff;
  }

  .volume{
    margin-top:8px;
  }

  /* 中央 */
  .center{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:16px;
  }

  textarea{
    width:100%;
    max-width:420px;
    height:100px;
    padding:12px;
    border-radius:12px;
    border:none;
    resize:none;
    font-size:14px;
  }

  .wheel-wrap{
    position:relative;
    width:420px;
    height:420px;
  }

  canvas{
    background:#ffffff;
    border-radius:50%;
  }

  .start-text{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.6em;
    font-weight:bold;
    color:#999;
    pointer-events:none;
  }

  .arrow{
    position:absolute;
    bottom:-18px;
    left:50%;
    transform:translateX(-50%);
    font-size:28px;
  }

  .result{
    font-size:2em;
    font-weight:bold;
    margin-top:12px;
    text-decoration:underline;
  }

  /* 右 */
  .right{
    border-radius:16px;
    padding:16px;
    background:#ffffff;
    overflow-y:auto;
    margin:24px 0;
  }
</style>
</head>

<body>
<div class="app">

  <!-- 左 -->
  <div class="left">
    <div class="tab">ルレット</div>

    <div class="volume">
      音量
      <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6">
    </div>

    <button id="genUrl">URL生成</button>
    <input id="urlBox" readonly />
  </div>

  <!-- 中央 -->
  <div class="center">
    <textarea id="itemsInput" placeholder="改行で区切る">A
B
C</textarea>

    <div class="wheel-wrap">
      <canvas id="wheel" width="420" height="420"></canvas>
      <div class="start-text">抽選開始</div>
      <div class="arrow">▲</div>
    </div>

    <div id="result" class="result"></div>
  </div>

  <!-- 右 -->
  <div class="right">
    <h3>履歴</h3>
    <ul id="history"></ul>
  </div>

</div>

<script>
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const input = document.getElementById("itemsInput");
const resultEl = document.getElementById("result");
const historyEl = document.getElementById("history");

let rotation = 0;
let spinning = false;

function getItems(){
  return input.value.split("\n").map(v=>v.trim()).filter(Boolean);
}

function drawWheel(hitIndex=null){
  const items = getItems();
  const r = canvas.width/2;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(items.length===0) return;

  const angle = 2*Math.PI/items.length;
  const colors = ["var(--pastel1)","var(--pastel2)","var(--pastel3)","var(--pastel4)"];

  items.forEach((item,i)=>{
    ctx.beginPath();
    ctx.moveTo(r,r);
    ctx.fillStyle = (i===hitIndex) ? "var(--hit)" : colors[i%colors.length];
    ctx.arc(r,r,r, angle*i+rotation, angle*(i+1)+rotation);
    ctx.fill();

    ctx.strokeStyle="var(--border)";
    ctx.stroke();

    ctx.save();
    ctx.translate(r,r);
    ctx.rotate(angle*i+angle/2+rotation);
    ctx.textAlign="right";
    ctx.fillStyle="#333";
    ctx.font="14px sans-serif";
    ctx.fillText(item,r-10,5);
    ctx.restore();
  });
}

function spin(){
  if(spinning) return;
  const items = getItems();
  if(items.length===0) return;

  spinning=true;
  let speed=0.3;
  const timer=setInterval(()=>{
    rotation+=speed;
    speed*=0.98;
    drawWheel();
    if(speed<0.002){
      clearInterval(timer);
      spinning=false;

      const fixed = (360 - (rotation*180/Math.PI % 360)) % 360;
      const adjusted = (fixed + 90) % 360; // ▼下判定
      const index = Math.floor(adjusted / (360/items.length));

      drawWheel(index);
      const res = items[index];
      resultEl.textContent = res;

      const li=document.createElement("li");
      li.textContent=res;
      historyEl.prepend(li);
    }
  },16);
}

canvas.addEventListener("click",spin);
input.addEventListener("input",()=>drawWheel());
drawWheel();
</script>
</body>
</html>
